{% extends "base.html" %}
{% block title %}Chat History | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<div class="container py-4 animate__animated animate__fadeIn">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-primary d-flex align-items-center">
      <i class="fas fa-comments me-2"></i> Chat History
    </h4>
  </div>

  {% if users %}
  <div class="mb-3">
    <input type="text" id="liveSearchInput" class="form-control form-control-sm shadow-sm"
      placeholder="ðŸ” Filter by username, email or role...">
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm border rounded" id="usersTable">
      <thead class="table-light">
        <tr>
          <th><i class="fas fa-user me-1"></i> Username</th>
          <th scope="col"><i class="fas fa-id-badge me-1"></i> Roll Number</th>
          <th><i class="fas fa-envelope me-1"></i> Email</th>
          <th><i class="fas fa-user-tag me-1"></i> Role</th>
          <th class="text-center"><i class="fas fa-comments me-1"></i> Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.username }}</td>
          <td>{{ user.roll_number or '-' }}</td>
          <td>{{ user.email }}</td>
          <td><span class="badge bg-secondary text-uppercase">{{ user.role.title() }}</span></td>
          <td class="text-center">
            <a href="{{ url_for('chat_with_user', user_id=user.id) }}"
              class="btn btn-success btn-sm rounded-circle me-1" title="Open Chat">
              <i class="fas fa-comment-dots"></i>
            </a>
            <button class="btn btn-danger btn-sm rounded-circle delete-chat-btn" data-user-id="{{ user.id }}"
              title="Delete Chat">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <div class="alert alert-info d-flex align-items-center mt-4">
    <i class="fas fa-info-circle me-2"></i>
    You haven't chatted with anyone yet.
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>

  document.getElementById('liveSearchInput')?.addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(filter) ? '' : 'none';
    });
  });


  document.querySelectorAll('.delete-chat-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const userId = this.dataset.userId;
      if (!confirm("Are you sure you want to delete this chat?")) return;

      try {
        const response = await fetch(`/chat/delete/${userId}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.success) {
          this.closest('tr').remove();
        } else {
          alert("Failed to delete chat.");
        }
      } catch (err) {
        console.error("Error deleting chat:", err);
        alert("Something went wrong.");
      }
    });
  });
</script>

<style>
  .btn.rounded-circle {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: all 0.2s ease-in-out;
  }

  .btn.rounded-circle:hover {
    transform: scale(1.05);
  }
</style>
{% endblock %}