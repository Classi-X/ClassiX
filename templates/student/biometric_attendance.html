{% extends "base.html" %}

{% block title %}Biometric Attendance | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2f5b5c3cc.js" crossorigin="anonymous"></script>


<div class="container py-3">
  <div class="row justify-content-center">
    <div class="col-lg-8">


      <div class="card shadow-sm border-0 mb-4 animate__animated animate__fadeIn">
        <div class="card-header bg-primary text-white text-center">
          <h4 class="mb-0">
            <i class="fas fa-fingerprint me-2"></i> Biometric Attendance
          </h4>
        </div>
        <div class="card-body text-center">
          <div class="mb-4">
            <i class="fas fa-fingerprint fa-5x text-muted" id="fingerprintIcon"></i>
          </div>
          <p id="scannerStatus" class="text-muted mb-4">Checking biometric support...</p>
          <button class="btn btn-lg btn-primary px-4 shadow-sm" id="authButton" onclick="authenticateUser()" disabled>
            <i class="fas fa-shield-alt me-2"></i>Verify Fingerprint
          </button>
        </div>
      </div>


      <div id="result" class="text-center my-4 fs-6 fw-medium text-secondary"></div>


      <div class="card shadow-sm border-0 mb-4 animate__animated animate__fadeInUp">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2 text-primary"></i> How It Works
          </h6>
        </div>
        <div class="card-body small text-muted">
          <ul class="mb-0">
            <li>Uses <strong>WebAuthn API</strong> for biometric authentication</li>
            <li>Requires a <strong>secure connection (HTTPS)</strong></li>
            <li>Needs a <strong>configured biometric system</strong> (e.g. fingerprint, face ID)</li>
          </ul>
        </div>
      </div>


      <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2 text-primary"></i> Biometric Attendance Info
          </h6>
        </div>
        <div class="card-body small text-muted">
          <div class="row g-4">
            <div class="col-md-6">
              <h6 class="text-primary mb-2"><i class="fas fa-thumbs-up me-1"></i> Benefits</h6>
              <ul class="mb-0">
                <li>Instant attendance marking</li>
                <li>Eliminates manual errors</li>
                <li>Prevents proxy attendance</li>
                <li>Secure & accurate</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="text-primary mb-2"><i class="fas fa-list-check me-1"></i> Instructions</h6>
              <ul class="mb-0">
                <li>Ensure scanner is connected</li>
                <li>Click verify to scan fingerprint</li>
                <li>Confirm once verification completes</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<style>
  #authButton {
    transition: all 0.3s ease-in-out;
  }

  #authButton:enabled:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.15);
  }
</style>

<script>
  async function checkSupport() {
    const status = document.getElementById("scannerStatus");
    const button = document.getElementById("authButton");

    if (window.PublicKeyCredential && PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable) {
      try {
        const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
        if (available) {
          status.textContent = "Biometric support detected. Click to verify.";
          button.disabled = false;
        } else {
          status.textContent = "Biometric device not available.";
        }
      } catch (err) {
        status.textContent = "Error checking biometric availability.";
        console.error(err);
      }
    } else {
      status.textContent = "WebAuthn not supported in this browser.";
    }
  }

  async function authenticateUser() {
    const icon = document.getElementById("fingerprintIcon");
    const status = document.getElementById("scannerStatus");
    const button = document.getElementById("authButton");
    const result = document.getElementById("result");

    icon.className = "fas fa-spinner fa-5x text-primary fa-spin";
    status.textContent = "Waiting for fingerprint verification...";
    button.disabled = true;

    try {
      const assertion = await navigator.credentials.get({
        publicKey: {
          challenge: new Uint8Array(32),
          timeout: 60000,
          userVerification: "required"
        }
      });

      icon.className = "fas fa-check-circle fa-5x text-success";
      status.textContent = "Fingerprint verified successfully!";
      result.innerHTML = `
            <div class="alert alert-success mt-3">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Verification Success!</strong><br>
                Time: ${new Date().toLocaleTimeString()}
            </div>
        `;
    } catch (err) {
      console.error(err);
      icon.className = "fas fa-times-circle fa-5x text-danger";
      status.textContent = "Fingerprint verification failed or cancelled.";
      result.innerHTML = `
            <div class="alert alert-danger mt-3">
                <i class="fas fa-exclamation-circle me-2"></i>
                Authentication failed.<br>
                ${err.message}
            </div>
        `;
    }

    button.disabled = false;
  }

  document.addEventListener("DOMContentLoaded", checkSupport);
</script>
{% endblock %}