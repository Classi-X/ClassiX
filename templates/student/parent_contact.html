{% extends "base.html" %}

{% block title %}Parent Contact Information | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}

<div class="container py-3">
  <div class="modal fade" id="parentHelpModal" tabindex="-1" aria-labelledby="parentHelpLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content border-0 shadow-sm">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="parentHelpLabel">
            <i class="fas fa-info-circle me-2"></i> Instructions
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>This section allows you to update the parent's or guardian's contact information for communication
            purposes.</p>
          <ul>
            <li><strong>Phone Number:</strong> Used for SMS alerts when the student is absent.</li>
            <li><strong>Email Address:</strong> Required for receiving monthly attendance reports.</li>
            <li><strong>OTP Verification:</strong> Ensures the email address is valid before submission.</li>
            <li><strong>Preferences:</strong> Notifications are auto-enabled for critical updates and cannot be turned
              off for safety reasons.</li>
          </ul>
          <div class="alert alert-warning small">
            <i class="fas fa-exclamation-triangle me-1"></i> Keep this information updated to avoid missing important
            notifications.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">


      <div class="card shadow-sm border-0 animate__animated animate__fadeIn">
        <div
          class="card-header bg-primary text-white d-flex align-items-center d-flex justify-content-between gap-2 p-2 flex-wrap">
          <h4 class="mb-0"><i class="fas fa-users me-2"></i> Parent/Guardian Contact Information</h4>
          <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#parentHelpModal">
            <i class="fas fa-circle-info me-1"></i> Instructions
          </button>
        </div>
        <div class="card-body">
          <div class="alert alert-info d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <div>
              <strong>Important:</strong> This information is used for sending attendance notifications and school
              updates.
            </div>
          </div>

          <form method="POST">

            <div class="mb-3">
              <label for="parent_name" class="form-label">Parent/Guardian Name *</label>
              <input type="text" class="form-control" id="parent_name" name="parent_name"
                value="{{ contact.parent_name if contact else '' }}" required>
            </div>


            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="phone" class="form-label">Phone Number *</label>
                  <input type="tel" class="form-control" id="phone" name="phone"
                    value="{{ contact.phone if contact else '' }}" placeholder="+91 9999999999" required>
                  <div class="form-text">Used for SMS notifications</div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label for="email" class="form-label">Email Address *</label>
                  <div class="input-group">
                    <input type="email" class="form-control" id="email" name="email"
                      value="{{ contact.email if contact else '' }}" placeholder="parentname@gmail.com" required>
                    <button class="btn btn-outline-secondary" type="button" id="sendOtpBtn">
                      <span id="sendOtpText">Send OTP</span>
                      <span id="otpSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                    </button>
                  </div>
                  <div class="form-text">Used for email notifications</div>
                </div>


                <div class="mb-3 mt-2" id="otpSection" style="display: none;">
                  <label for="otp" class="form-label">Enter OTP *</label>
                  <input type="text" class="form-control" id="otp" name="otp" placeholder="Enter OTP sent to email"
                    required>
                </div>
              </div>
            </div>


            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-bell me-2"></i> Notification Preferences</h6>
              </div>
              <div class="card-body">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="sms_notifications" checked disabled>
                  <label class="form-check-label" for="sms_notifications">SMS notifications for absences</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="email_notifications" checked disabled>
                  <label class="form-check-label" for="email_notifications">Email notifications for monthly
                    reports</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="low_attendance_alerts" checked disabled>
                  <label class="form-check-label" for="low_attendance_alerts">Alerts for attendance below 75%</label>
                </div>
              </div>
            </div>


            <div class="d-flex justify-content-between">
              <a href="{{ url_for('student_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Save Contact Information
              </button>
            </div>
          </form>
        </div>
      </div>


      {% if contact %}
      <div class="card mt-4 shadow-sm animate__animated animate__fadeInUp">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fas fa-address-book me-2 text-secondary"></i> Current Contact Information</h6>
        </div>
        <div class="card-body">
          <div class="row gy-3">
            <div class="col-md-4">
              <p><strong>Name:</strong><br>{{ contact.parent_name }}</p>
            </div>
            <div class="col-md-4">
              <p><strong>Phone:</strong><br>{{ contact.phone or 'Not provided' }}</p>
            </div>
            <div class="col-md-4">
              <p><strong>Email:</strong><br>{{ contact.email or 'Not provided' }}</p>
            </div>
          </div>
          <small class="text-muted d-block mt-2">Last updated: {{ contact.updated_at.strftime('%Y-%m-%d %H:%M')
            }}</small>
        </div>
      </div>
      {% endif %}


      <div class="card mt-4 shadow-sm animate__animated animate__fadeInUp">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fas fa-envelope me-2 text-info"></i> Sample Notifications</h6>
        </div>
        <div class="card-body">
          <h6 class="text-muted fw-semibold">Sample SMS for Absence:</h6>
          <div class="alert alert-light border">
            <small>
              <strong>School Attendance Alert</strong><br>
              Dear {{ contact.parent_name if contact else 'Parent' }},
              {{ current_user.username }} was absent on 2025-06-14 for Mathematics.
              Please contact school if this is incorrect.
            </small>
          </div>

          <h6 class="text-muted fw-semibold mt-3">Sample Email for Monthly Report:</h6>
          <div class="alert alert-light border">
            <small>
              <strong>Subject: Monthly Attendance Report - {{ current_user.username }}</strong><br>
              Dear {{ contact.parent_name if contact else 'Parent' }},<br><br>
              This is the monthly attendance report for {{ current_user.username }}.<br>
              Total Classes: 20<br>
              Present: 18<br>
              Attendance Percentage: 90%<br><br>
              Thank you for your attention to your child's education.
            </small>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<script>
  document.getElementById('sendOtpBtn').addEventListener('click', function () {
    const email = document.getElementById('email').value.trim();
    const btn = this;
    const spinner = document.getElementById('otpSpinner');
    const text = document.getElementById('sendOtpText');

    if (!email) return alert("Please enter an email first.");

    btn.disabled = true;
    spinner.classList.remove('d-none');
    text.textContent = "Sending...";

    fetch('/send-otps', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, role: 'parent' })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("OTP sent successfully. Please check your email.");
          document.getElementById('otpSection').style.display = 'block';
        } else {
          alert(data.message || "Failed to send OTP.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error occurred while sending OTP.");
      })
      .finally(() => {
        btn.disabled = false;
        spinner.classList.add('d-none');
        text.textContent = "Send OTP";
      });
  });
</script>

{% endblock %}