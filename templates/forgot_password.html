{% extends "base.html" %}

{% block title %}Forgot Password | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow-lg animate__animated animate__fadeIn">
        <div class="card-header bg-warning text-dark text-center">
          <h4><i class="fas fa-unlock-alt me-2"></i>Forgot Password</h4>
        </div>
        <div class="card-body p-4">
          <div class="mb-3">
            <label for="email" class="form-label fw-semibold">Registered Email</label>
            <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
          </div>

          <div class="d-grid mb-3">
            <button class="btn btn-warning" id="sendOtpBtn" onclick="sendOtp()">
              <span id="sendOtpText"><i class="fas fa-paper-plane me-2"></i>Send OTP</span>
              <span id="sendOtpSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                aria-hidden="true"></span>
            </button>
          </div>

          <div id="otpSection" style="display:none;">
            <div class="mb-3">
              <label for="otpInput" class="form-label fw-semibold">Enter OTP</label>
              <input type="text" id="otpInput" class="form-control" placeholder="6-digit OTP">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" id="verifyOtpBtn" onclick="verifyOtp()">
                <span id="verifyOtpText"><i class="fas fa-check-circle me-2"></i>Verify OTP</span>
                <span id="verifyOtpSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                  aria-hidden="true"></span>
              </button>
            </div>
          </div>

          <div id="feedback" class="mt-3 text-center"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function sendOtp() {
    const email = document.getElementById('email').value.trim();
    const btn = document.getElementById('sendOtpBtn');
    const spinner = document.getElementById('sendOtpSpinner');
    const text = document.getElementById('sendOtpText');
    const feedback = document.getElementById('feedback');

    if (!email) {
      feedback.innerHTML = `<div class="alert alert-danger">Please enter your email.</div>`;
      return;
    }

    btn.disabled = true;
    spinner.classList.remove('d-none');
    text.innerHTML = 'Sending...';

    fetch('/send-forgot-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    })
      .then(res => res.json().then(data => ({ status: res.status, body: data })))
      .then(({ status, body }) => {
        if (status === 200 && body.success) {
          document.getElementById('otpSection').style.display = 'block';
          feedback.innerHTML = `<div class="alert alert-success">OTP sent successfully to ${email}</div>`;
        } else {
          feedback.innerHTML = `<div class="alert alert-danger">${body.message || 'Failed to send OTP'}</div>`;
        }
      })
      .catch(() => {
        feedback.innerHTML = `<div class="alert alert-danger">Something went wrong. Please try again later.</div>`;
      })
      .finally(() => {
        btn.disabled = false;
        spinner.classList.add('d-none');
        text.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send OTP';
      });
  }

  function verifyOtp() {
    const otp = document.getElementById('otpInput').value.trim();
    const btn = document.getElementById('verifyOtpBtn');
    const spinner = document.getElementById('verifyOtpSpinner');
    const text = document.getElementById('verifyOtpText');
    const feedback = document.getElementById('feedback');

    if (!otp) {
      feedback.innerHTML = `<div class="alert alert-danger">Please enter the OTP.</div>`;
      return;
    }

    btn.disabled = true;
    spinner.classList.remove('d-none');
    text.innerHTML = 'Verifying...';

    fetch('/verify-forgot-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ otp })
    })
      .then(res => res.json().then(data => ({ status: res.status, body: data })))
      .then(({ status, body }) => {
        if (status === 200 && body.success) {
          feedback.innerHTML = `<div class="alert alert-success">OTP verified successfully. Redirecting to reset page...</div>`;
          setTimeout(() => {
            window.location.href = "/reset-password";
          }, 1500);
        } else {
          feedback.innerHTML = `<div class="alert alert-danger">${body.message || 'Invalid OTP'}</div>`;
        }
      })
      .catch(() => {
        feedback.innerHTML = `<div class="alert alert-danger">Something went wrong. Please try again.</div>`;
      })
      .finally(() => {
        btn.disabled = false;
        spinner.classList.add('d-none');
        text.innerHTML = '<i class="fas fa-check-circle me-2"></i>Verify OTP';
      });
  }
</script>

{% endblock %}