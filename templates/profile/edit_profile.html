{% extends "base.html" %}

{% block title %}Edit My Profile | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<div class="container py-3">
  {% if user.role == 'student' %}
  <!-- ADD: Fingerprint Enrollment Modal -->
  <div class="modal fade" id="fingerprintModal" tabindex="-1" aria-labelledby="fingerprintModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header bg-dark text-white rounded-top-4">
          <h5 class="modal-title" id="fingerprintModalLabel">
            <i class="fas fa-fingerprint me-2"></i> Register Your Fingerprint
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="alert alert-secondary d-flex align-items-start gap-2">
            <i class="fas fa-info-circle mt-1"></i>
            <div>
              Place the same finger <strong>twice</strong> when prompted. Keep it flat and steady.
            </div>
          </div>

          <div id="fpStatus" class="p-3 rounded-3 bg-light border small">
            <div class="d-flex align-items-center gap-2">
              <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
              <div><strong>Ready:</strong> Click ‚ÄúStart Enrollment‚Äù and follow on-screen steps‚Ä¶</div>
            </div>
          </div>

          <div class="text-center my-3">
            <i class="fas fa-hand-point-up fa-2x text-muted d-block mb-2"></i>
            <small class="text-muted">You‚Äôll be asked to place and lift your finger.</small>
          </div>
        </div>

        <div class="modal-footer">
          <button id="btnStartEnroll" class="btn btn-primary">
            <i class="fas fa-play me-1"></i> Start Enrollment
          </button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-xmark me-1"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD: JS to call the enrollment API and show progress -->
  <script>
    (function () {
      const startBtn = document.getElementById('btnStartEnroll');
      const statusBox = document.getElementById('fpStatus');

      function setStatus(html, tone = 'light') {
        statusBox.className = `p-3 rounded-3 border small bg-${tone}`;
        statusBox.innerHTML = html;
      }

      async function enroll() {
        startBtn.disabled = true;

        setStatus(`
        <div class="d-flex align-items-center gap-2">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <div><strong>Step 1:</strong> Place finger on sensor‚Ä¶</div>
        </div>
      `, 'warning');

        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 120000); // 120s safety

          // Kick the API (long running; do not send any body)
          let res = await fetch('{{ url_for("api_fingerprint_enroll") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: controller.signal
          });

          clearTimeout(timeout);

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Enrollment failed.');
          }

          const data = await res.json();

          if (!data.success) {
            throw new Error(data.error || 'Enrollment failed.');
          }

          setStatus(`
          <div class="d-flex align-items-start gap-2">
            <i class="fas fa-check-circle mt-1"></i>
            <div>
              <div class="fw-bold">Fingerprint registered successfully.</div>
              <div class="small text-muted">User: <code>${data.data.username}</code> (ID: ${data.data.user_id})</div>
              <div class="small text-muted">Sensor Slot: <code>${data.data.sensor_position}</code></div>
            </div>
          </div>
        `, 'success');

        } catch (err) {
          let msg = (err && err.message) ? err.message : 'Unknown error';
          // Attempt to parse JSON error from server if stringified
          try {
            const maybe = JSON.parse(msg);
            if (maybe && maybe.error) msg = maybe.error;
          } catch (_) { }

          setStatus(`
          <div class="d-flex align-items-start gap-2">
            <i class="fas fa-triangle-exclamation mt-1"></i>
            <div>
              <div class="fw-bold">Enrollment failed.</div>
              <div class="small">${msg}</div>
              <ul class="small mt-2 mb-0">
                <li>Ensure sensor is connected on correct port and powered.</li>
                <li>Keep finger flat; try a different finger if quality is low.</li>
                <li>Ask admin to check <code>FINGERPRINT_SERIAL_PORT</code> config.</li>
              </ul>
            </div>
          </div>
        `, 'danger');

        } finally {
          startBtn.disabled = false;
        }
      }

      if (startBtn) {
        startBtn.addEventListener('click', enroll);
      }
    })();
  </script>
  {% endif %}

  <div class="modal fade" id="profileHelpModal" tabindex="-1" aria-labelledby="profileHelpLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="profileHelpLabel">
            <i class="fas fa-info-circle me-2"></i> Profile Update Instructions
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 class="fw-bold mb-3 text-dark">General Instructions (All Users)</h6>
          <ul>
            <li><strong>Username:</strong> Should reflect your real or official name.</li>
            <li><strong>Password:</strong> Leave blank if you don‚Äôt want to change it.</li>
          </ul>

          {% if user.role == 'student' %}
          <hr class="my-4">
          <h6 class="fw-bold text-primary mb-2">For Students</h6>
          <ul>
            <li><strong>Profile Photo:</strong> Upload a clear front-facing image for face recognition attendance.</li>
            <li><strong>Roll Number:</strong> Must match your school/college records.</li>
            <li><strong>Class:</strong> Select your current class or semester.</li>
            <li><strong>Fingerprint:</strong> Click ‚ÄúRegister Fingerprint‚Äù to enroll your finger for attendance.</li>
          </ul>
          {% if institution_type == 'school' %}
          <ul>
            <li><strong>Stream:</strong> Required for Class 11 and 12 (e.g., Science, Commerce, Arts).</li>
          </ul>
          {% elif institution_type in ['college', 'university'] %}
          <ul>
            <li><strong>Degree:</strong> Choose your enrolled course (e.g., B.Sc, B.Com, B.A).</li>
            <li><strong>Subjects:</strong> Select multiple if required. Use branch-specific format like
              <code>Physics ‚Äì Computer Engineering</code> if applicable.
            </li>
          </ul>
          {% endif %}
          {% endif %}

          {% if user.role == 'teacher' %}
          <hr class="my-4">
          <h6 class="fw-bold text-primary mb-2">For Teachers</h6>
          <ul>
            <li><strong>Username:</strong> Preferably use your full name or staff ID.</li>
            <li><strong>Email:</strong> Should be your institutional email (if editable).</li>
            <li><strong>Subjects:</strong> Ensure your subjects list is up to date for correct student mapping.</li>
          </ul>
          {% endif %}

          {% if user.role == 'parent' %}
          <hr class="my-4">
          <h6 class="fw-bold text-primary mb-2">For Parents</h6>
          <ul>
            <li><strong>Username:</strong> Use your full name (e.g., Ramesh Sharma).</li>
            <li><strong>Email / Phone:</strong> Should match the one registered with the school.</li>
            <li><strong>Children Mapping:</strong> Automatically linked with your ward(s). If any child is missing,
              contact admin.</li>
          </ul>
          {% endif %}

          {% if user.role == 'admin' %}
          <hr class="my-4">
          <h6 class="fw-bold text-primary mb-2">For Admins</h6>
          <ul>
            <li><strong>Username & Password:</strong> Ensure a strong password.</li>
            <li><strong>Email:</strong> This is used for system alerts and resets.</li>
            <li><strong>Permissions:</strong> Admins have full rights to manage teachers, students, and content. Handle
              responsibly.</li>
          </ul>
          {% endif %}

          <div class="alert alert-warning mt-4" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Need Help?</strong> Contact the system administrator or your institution's IT support if any detail
            is missing or incorrect.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-lg border-0 rounded-4 animate__animated animate__fadeIn">
    <div class="card-header bg-primary text-white rounded-top-4 d-flex align-items-center">
      <i class="fas fa-user-edit me-2 fs-5"></i>
      <h5 class="mb-0">Edit Profile</h5>
      <button class="btn btn-sm btn-light ms-auto" data-bs-toggle="modal" data-bs-target="#profileHelpModal">
        <i class="fas fa-circle-info me-1"></i> Help
      </button>
      {% if user.role == 'student' %}
      <button class="btn btn-sm btn-warning ms-2" data-bs-toggle="modal" data-bs-target="#fingerprintModal">
        <i class="fas fa-fingerprint me-1"></i>
        {{ 'Update Fingerprint' if user.fingerprint else 'Register Fingerprint' }}
      </button>
      {% endif %}
    </div>
    <div class="card-body">

      <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-user me-1 text-secondary"></i>Username
          </label>
          <input type="text" name="username" class="form-control" value="{{ user.username }}" required>
        </div>


        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-lock me-1 text-secondary"></i>New Password
            <small class="text-muted ms-1">(leave blank to keep current)</small>
          </label>
          <input type="password" name="password" class="form-control">
        </div>

        {% if user.role == 'student' %}
        <style>
          .example-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            object-position: center;
            border-radius: 8px;
          }
        </style>

        <div class="mb-3">
          <style>
            .profile-photo-wrapper {
              position: relative;
              width: 140px;
              height: 140px;
              margin: auto;
              cursor: pointer;
            }

            .profile-photo-wrapper input[type="file"] {
              display: none;
            }

            .profile-photo {
              width: 100%;
              height: 100%;
              object-fit: cover;
              border-radius: 50%;
              border: 3px solid #0d6efd;
              background-color: #f8f9fa;
            }

            .profile-placeholder {
              font-size: 3rem;
              color: #6c757d;
              background-color: #e9ecef;
              width: 100%;
              height: 100%;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              border: 3px dashed #adb5bd;
            }

            .profile-photo-wrapper:hover .profile-overlay {
              opacity: 1;
            }

            .profile-overlay {
              position: absolute;
              bottom: 0;
              width: 100%;
              height: 35%;
              background: rgba(0, 0, 0, 0.4);
              color: white;
              font-size: 0.85rem;
              border-radius: 0 0 50% 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              transition: 0.3s ease;
            }
          </style>

          <div class="mb-4">
            <label class="form-label fw-semibold d-block">
              <i class="fas fa-camera me-1 text-secondary"></i>Profile Photo (Optional but recommended)
            </label>

            <div class="text-center">
              <label class="profile-photo-wrapper position-relative d-inline-block" for="photoInput">

                <img id="profilePreview" src="{{ url_for('static', filename=user.photo) if user.photo else '' }}"
                  alt="Profile Photo" class="profile-photo"
                  style="display: {{ 'block' if user.photo else 'none' }}; max-width: 150px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.2);"
                  onerror="loadImageFromLocalStorage()">
                <script>
                  document.addEventListener('DOMContentLoaded', function () {
                    const photoInput = document.getElementById('photoInput');
                    const preview = document.getElementById('profilePreview');
                    const placeholder = document.getElementById('profilePlaceholder');

                    if (!preview.src || preview.src.includes('None')) {
                      const savedImage = localStorage.getItem('savedProfileImage');
                      if (savedImage) {
                        preview.src = savedImage;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                      }
                    }

                    photoInput.addEventListener('change', function () {
                      const file = this.files[0];
                      if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                          const base64Image = e.target.result;
                          preview.src = base64Image;
                          preview.style.display = 'block';
                          placeholder.style.display = 'none';

                          localStorage.removeItem('savedProfileImage');
                          localStorage.setItem('savedProfileImage', base64Image);
                        };
                        reader.readAsDataURL(file);
                      }
                    });

                  });

                  function loadImageFromLocalStorage() {
                    const preview = document.getElementById('profilePreview');
                    const placeholder = document.getElementById('profilePlaceholder');
                    const savedImage = localStorage.getItem('savedProfileImage');

                    if (savedImage) {
                      preview.src = savedImage;
                      preview.style.display = 'block';
                      placeholder.style.display = 'none';
                    } else {
                      preview.style.display = 'none';
                      placeholder.style.display = 'block';
                    }
                  }
                </script>

                <div id="profilePlaceholder" class="profile-placeholder text-secondary"
                  style="font-size: 100px; display: {{ 'none' if user.photo else 'block' }};">
                  <i class="fas fa-user-circle"></i>
                </div>

                <div
                  class="profile-overlay position-absolute top-50 start-50 translate-middle text-white bg-dark bg-opacity-75 px-3 py-2 rounded"
                  style="pointer-events: none;">
                  <i class="fas fa-camera me-1"></i> Change Photo
                </div>

                <input type="file" id="photoInput" name="photo" accept="image/*" style="display: none;">
              </label>
            </div>

            <div class="form-text mt-2">
              This photo will be used for facial recognition-based attendance. Please upload a clear, front‚Äëfacing image
              where your full face can be detected.
            </div>
          </div>
          <script>
            document.addEventListener('DOMContentLoaded', function () {
              const photoInput = document.getElementById('photoInput');
              const preview = document.getElementById('profilePreview');
              const placeholder = document.getElementById('profilePlaceholder');

              photoInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                  };
                  reader.readAsDataURL(file);
                }
              });
            });
          </script>

          <div class="mt-3">
            <label class="form-label fw-semibold">Example Photos</label>
            <div class="row text-center g-2">
              <div class="col-4 d-flex">
                <div class="border rounded p-2 h-100 d-flex flex-column justify-content-between">
                  <img
                    src="https://img.freepik.com/free-photo/portrait-white-man-isolated_53876-40306.jpg?semt=ais_hybrid&w=740"
                    class="img-fluid rounded mb-2 example-img" alt="Good front-facing male">
                  <div class="text-success"><i class="fas fa-check-circle me-1"></i> Clear Front‚ÄëFacing</div>
                </div>
              </div>
              <div class="col-4 d-flex">
                <div class="border rounded p-2 h-100 d-flex flex-column justify-content-between">
                  <img src="https://img.freepik.com/free-photo/side-view-man-with-face-mask_23-2148780042.jpg"
                    class="img-fluid rounded mb-2 example-img" alt="Bad covered face male">
                  <div class="text-danger"><i class="fas fa-times-circle me-1"></i> Covered Face (e.g. mask/glasses)
                  </div>
                </div>
              </div>
              <div class="col-4 d-flex">
                <div class="border rounded p-2 h-100 d-flex flex-column justify-content-between">
                  <img
                    src="https://images.openai.com/thumbnails/url/j65uDXicu1mSUVJSUGylr5-al1xUWVCSmqJbkpRnoJdeXJJYkpmsl5yfq5-Zm5ieWmxfaAuUsXL0S7F0Tw5xK3TOLjVL8zAIziv38sk1yg2srMxLLM3y8s2v8vAMiix2Sg4OtjTMjfBNzDHIDSrTNS8JSneLCE0yD1QrBgAxRio0"
                    class="img-fluid rounded mb-2 example-img" alt="Bad side-angle male">
                  <div class="text-danger"><i class="fas fa-times-circle me-1"></i> Side/Angled Face</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-id-badge me-1 text-secondary"></i>Roll Number <span class="text-danger">*</span>
          </label>
          <input type="text" name="roll_number" class="form-control" value="{{ user.roll_number or '' }}" required>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-layer-group me-1 text-secondary"></i>Class <span class="text-danger">*</span>
          </label>
          <select name="class_name" class="form-select" required>
            <option value="">Select Class</option>
            {% for cls in class_options %}
            <option value="{{ cls }}" {% if user.class_name==cls %}selected{% endif %}>{{ cls }}</option>
            {% endfor %}
          </select>
        </div>

        {% if institution_type == 'school' %}

        <div class="mb-3" id="streamField"
          style="display: {% if user.class_name.startswith('11') or user.class_name.startswith('12') %}block{% else %}none{% endif %};">
          <label class="form-label fw-semibold">
            <i class="fas fa-diagram-project me-1 text-secondary"></i>Stream
          </label>
          <select name="stream_or_semester" class="form-select">
            <option value="">Select Stream</option>
            {% for stream in stream_options %}
            <option value="{{ stream }}" {% if user.stream_or_semester==stream %}selected{% endif %}>{{ stream }}
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if institution_type in ['college', 'university'] %}

        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-graduation-cap me-1 text-secondary"></i>Degree
          </label>
          <select name="degree" class="form-select">
            <option value="">Select Degree</option>
            {% for degree in degree_options %}
            <option value="{{ degree }}" {% if user.degree==degree %}selected{% endif %}>{{ degree }}</option>
            {% endfor %}
          </select>
        </div>


        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-book-open me-1 text-secondary"></i>Subjects <small class="text-muted">(select
              multiple)</small>
          </label>
          <select name="subject" class="form-select" multiple>
            {% for subject in subject_options %}
            <option value="{{ subject }}" {% if subject in (user.subject or '' ).split(', ') %}selected{% endif %}>{{ subject }}</option>
            {% endfor %}
          </select>
          <div class="alert alert-info mt-2 py-3 px-4 rounded-3 border-start border-4 border-primary"
                                    role="alert">
                                    <h6 class="fw-bold text-primary mb-2">
                                        How to choose your subjects:
                                    </h6>

                                    <p class="mb-2">
                                        Please select your subjects carefully. If your college or university has
                                        different branches or specializations (like IT, CE, Marketing, etc.), your
                                        subjects may be listed in the format:
                                        <br><strong class="text-dark">Subject Name ‚Äì Branch/Specialization</strong>
                                    </p>

                                    <ul class="mb-2 ps-4">
                                        <li><span class="text-dark">Physics ‚Äì Computer Engineering</span></li>
                                        <li><span class="text-dark">Mathematics ‚Äì IT</span></li>
                                        <li><span class="text-dark">Business Communication ‚Äì Marketing</span></li>
                                    </ul>

                                    <p class="mb-2 text-secondary">
                                        <strong>Don‚Äôt see a branch or specialization?</strong><br>
                                        If you are in college or a general course without branches, just select the
                                        subject name:
                                    </p>

                                    <ul class="mb-2 ps-4">
                                        <li><span class="text-dark">Mathematics</span></li>
                                        <li><span class="text-dark">English</span></li>
                                        <li><span class="text-dark">Science</span></li>
                                    </ul>

                                    <p class="mb-0 text-secondary">
                                        <strong>Note:</strong> If you' re not sure which subject to select, please ask
              your teacher or check your syllabus. </p>
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="alert alert-info d-flex align-items-center">
      <i class="fas fa-info-circle me-2"></i>
      You can only update your username and password.
    </div>
    {% endif %}

    <div class="mt-4">
      <button type="submit" class="btn btn-success me-2">
        <i class="fas fa-save me-1"></i>Save
      </button>
      <a href="{{ url_for('view_own_profile') }}" class="btn btn-secondary">
        <i class="fas fa-times me-1"></i>Cancel
      </a>
    </div>
    </form>
  </div>
</div>
</div>


<style>
  .form-label {
    font-size: 0.95rem;
  }

  .card .btn {
    transition: all 0.2s ease-in-out;
  }

  .card .btn:hover {
    transform: translateY(-1px);
  }

  .form-select,
  .form-control {
    transition: box-shadow 0.2s ease-in-out;
  }

  .form-select:focus,
  .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
</style>

{% if user.role == 'student' and institution_type == 'school' %}
<script>

  document.addEventListener('DOMContentLoaded', () => {
    const classInput = document.querySelector('select[name="class_name"]');
    const streamField = document.getElementById('streamField');

    function toggleStreamField() {
      if (!streamField) return;
      streamField.style.display = (classInput.value.startsWith('11') || classInput.value.startsWith('12')) ? 'block' : 'none';
    }

    if (classInput && streamField) {
      toggleStreamField();
      classInput.addEventListener('change', toggleStreamField);
    }
  });
</script>
{% endif %}

{% if user.role == 'student' and institution_type in ['college', 'university'] %}
<script>

  document.addEventListener('DOMContentLoaded', () => {
    const subjectSelect = document.querySelector('select[name="subject"]');
    if (!subjectSelect) return;


    const subjectContainer = subjectSelect.parentNode;
    const searchBox = document.createElement('input');
    searchBox.type = 'text';
    searchBox.className = 'form-control mb-2';
    searchBox.placeholder = 'üîç Search Subject...';
    subjectContainer.insertBefore(searchBox, subjectSelect);

    searchBox.addEventListener('input', function () {
      const search = this.value.toLowerCase();
      const options = subjectSelect.querySelectorAll('option');
      options.forEach(option => {
        option.style.display = option.textContent.toLowerCase().includes(search) ? 'block' : 'none';
      });
    });
  });
</script>
{% endif %}
{% endblock %}