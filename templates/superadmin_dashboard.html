{% extends "base.html" %}

{% block title %}Super Admin Dashboard | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<script src="https://kit.fontawesome.com/a2e0ad04e3.js" crossorigin="anonymous"></script>

<div class="container py-4">
    <div class="modal fade" id="superAdminHelpModal" tabindex="-1" aria-labelledby="superAdminHelpModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="superAdminHelpModalLabel">
                        <i class="fas fa-info-circle me-2"></i> Super Admin Dashboard Help
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This dashboard allows you to manage users by their roles:</p>
                    <ul class="ps-3">
                        <li><strong>Filter & Search:</strong> Use the search box beside each role to quickly find users.
                        </li>
                        <li><strong>Export CSV:</strong> Click the download icon to export that role's user data.</li>
                        <li><strong>Status Badges:</strong> <span class="badge bg-success">active</span> or <span
                                class="badge bg-secondary">inactive</span> indicates account state.</li>
                        <li><strong>Delete:</strong> You can delete users permanently using the delete button.</li>
                    </ul>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        Tip: Keep backups before deleting user records.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 d-flex align-items-center text-primary fw-bold">
            <i class="fas fa-user-shield me-2"></i> Super Admin Dashboard
        </h2>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#superAdminHelpModal">
            <i class="fas fa-info-circle me-1"></i> Help
        </button>
    </div>

    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger mb-4">
        <i class="fas fa-sign-out-alt me-1"></i> Logout
    </a>
    <a class="btn btn-outline-primary mb-4" href="{{ url_for('chat_history') }}" id="myChatsLink">
        <div class="d-flex align-items-center blink-area" id="blinkArea">
            <i class="fas fa-comments me-1"></i>
            <span class="chat-label">My Chats</span>
        </div>
    </a>
    <style>
        .blink-area.blinking {
            color: #dc3545 !important;
            animation: blinkRed 1.2s ease-in-out infinite;
            font-weight: 600;
        }

        .blink-area.blinking i {
            color: #dc3545 !important;
        }

        @keyframes blinkRed {

            0%,
            100% {
                opacity: 1;
                text-shadow: 0 0 5px rgba(220, 53, 69, 0.6);
            }

            50% {
                opacity: 0.4;
                text-shadow: 0 0 10px rgba(220, 53, 69, 0.9);
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const blinkArea = document.getElementById('blinkArea');

            async function checkNewChats() {
                try {
                    const res = await fetch('/chat/has-new');
                    const data = await res.json();
                    if (data.new_message) {
                        blinkArea.classList.add('blinking');
                    } else {
                        blinkArea.classList.remove('blinking');
                    }
                } catch (err) {
                    console.error("Error checking chat notifications", err);
                }
            }

            checkNewChats();
            setInterval(checkNewChats, 10000);
        });
    </script>
    <style>
        .blink-area.blinking {
            color: #dc3545 !important;
            animation: blinkRed 1.2s ease-in-out infinite;
            font-weight: 600;
        }

        .blink-area.blinking i {
            color: #dc3545 !important;
        }

        @keyframes blinkRed {

            0%,
            100% {
                opacity: 1;
                text-shadow: 0 0 5px rgba(220, 53, 69, 0.6);
            }

            50% {
                opacity: 0.4;
                text-shadow: 0 0 10px rgba(220, 53, 69, 0.9);
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const blinkArea = document.getElementById('blinkArea');

            async function checkNewChats() {
                try {
                    const res = await fetch('/chat/has-new');
                    const data = await res.json();
                    if (data.new_message) {
                        blinkArea.classList.add('blinking');
                    } else {
                        blinkArea.classList.remove('blinking');
                    }
                } catch (err) {
                    console.error("Error checking chat notifications", err);
                }
            }

            checkNewChats();
            setInterval(checkNewChats, 10000);
        });
    </script>


    {% for role, user_list in users.items() %}
    <div class="card mb-5 shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-capitalize"><i class="fas fa-users me-2"></i>{{ role }}</h5>
            <div class="d-flex justify-content-end p-2">
                <button id="downloadCSV" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download"></i>
                </button>
            </div>
            <input type="text" class="form-control form-control-sm w-50" placeholder="Search {{ role }}..."
                onkeyup="filterTable(this, 'table-{{ role }}')">
        </div>
        <style>
            #table- {
                    {
                    role
                }
            }

            thead th {
                position: sticky;
                top: 0;
                z-index: 1;
            }
        </style>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <script>
                document.getElementById('downloadCSV').addEventListener('click', function () {
                    const table = document.getElementById('table-{{ role }}');
                    const allRows = table.querySelectorAll('thead tr, tbody tr');
                    let csv = [];

                    allRows.forEach(row => {
                        if (row.offsetParent !== null) {
                            const cols = row.querySelectorAll('th, td');
                            const rowData = [];
                            cols.forEach(col => {
                                let text = col.innerText.trim().replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                                rowData.push(`"${text}"`);
                            });
                            csv.push(rowData.join(','));
                        }
                    });

                    const csvContent = csv.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'users.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            </script>

            <table class="table table-bordered table-striped mb-0" id="table-{{ role }}">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in user_list %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if user.status == 'active' else 'secondary' }}">{{
                                user.status }}</span>
                        </td>
                        <td>
                            <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}"
                                onsubmit="return confirm('Delete this user?');">
                                <button class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5">No users found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function filterTable(input, tableId) {
        const filter = input.value.toLowerCase();
        const table = document.getElementById(tableId);
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            let rowText = rows[i].innerText.toLowerCase();
            rows[i].style.display = rowText.includes(filter) ? '' : 'none';
        }
    }
</script>

{% endblock %}