{% extends "base.html" %}

{% block title %}Mark Attendance | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="modal fade" id="markAttendanceHelpModal" tabindex="-1" aria-labelledby="markAttendanceHelpModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-sm">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="markAttendanceHelpModalLabel">
            <i class="fas fa-info-circle me-2"></i> Attendance Marking Instructions
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <h6 class="fw-bold text-secondary">ðŸ§­ Step-by-Step Instructions</h6>
          <ol class="mt-2 ps-3">
            <li><strong>Select Class/Semester:</strong> Choose the relevant class from the dropdown.</li>

            <li><strong>If applicable:</strong>
              <ul>
                <li>Select <strong>Subject</strong> (for college/university only).</li>
                <li>Select <strong>Stream</strong> (only for Class 11 or 12).</li>
                <li>Select <strong>Degree</strong> (if required for institution type).</li>
              </ul>
            </li>

            <li><strong>Date & Time</strong> is auto-filled based on your current system time in IST.</li>

            <li>Click <strong>"Load Students"</strong> to fetch student list.</li>

            <li>Mark each student as <strong>Present</strong> or <strong>Absent</strong> manually, or use:
              <ul>
                <li><span class="badge bg-success">Mark All Present</span> â€“ to mark everyone present</li>
                <li><span class="badge bg-warning text-dark">Mark All Absent</span> â€“ to mark everyone absent</li>
              </ul>
            </li>

            <li>Finally, click <strong>"Save Attendance"</strong> to submit.</li>
          </ol>

          <hr class="my-3">

          <h6 class="fw-bold text-secondary">ðŸ“Œ Notes</h6>
          <ul class="mb-0">
            <li>All required fields must be selected to load students.</li>
            <li>Attendance is recorded along with subject, stream/degree if applicable.</li>
            <li>You can only mark attendance once per student per subject per day.</li>
          </ul>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-lg border-0 mt-5 animate__animated animate__fadeIn">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i>Mark Attendance</h4>
      <button class="btn btn-sm btn-outline-light ms-auto" data-bs-toggle="modal"
        data-bs-target="#markAttendanceHelpModal">
        <i class="fas fa-circle-info me-1"></i> Help
      </button>

    </div>
    <div class="card-body bg-light">
      <form method="POST" id="attendanceForm">
        <div class="row g-4 mb-4">

          <div class="col-md-3">
            <input type="hidden" id="filtered_student_ids" name="filtered_student_ids">
            <label for="class_name" class="form-label fw-semibold">
              <i class="fas fa-layer-group me-1 text-primary"></i>Class/Semester <span class="text-danger">*</span>
            </label>
            <select class="form-select shadow-sm" id="class_name" name="class_name" required onchange="showFields()">
              <option value="">Select Class/Semester</option>
              {% set seen_classes = [] %}
              {% for assignment in assignments %}
              {% if assignment.class_name not in seen_classes %}
              {% set _ = seen_classes.append(assignment.class_name) %}
              <option value="{{ assignment.class_name }}">{{ assignment.class_name }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>


          <div class="col-md-3" id="subjectField" style="display: none;">
            <label for="subject" class="form-label fw-semibold">
              <i class="fas fa-book me-1 text-info"></i>Subject <span id="subjectRequired"
                class="text-danger d-none">*</span>
            </label>
            <select class="form-select shadow-sm" id="subject" name="subject">
              <option value="" disabled selected>Select Subject</option>
              {% for assignment in assignments %}
              {% if assignment.subject %}
              <option value="{{ assignment.subject }}" data-class="{{ assignment.class_name }}">{{ assignment.subject }}
              </option>
              {% endif %}
              {% endfor %}
            </select>
          </div>


          <div class="col-md-3" id="streamField" style="display: none;">
            <label for="stream_or_semester" class="form-label fw-semibold">
              <i class="fas fa-code-branch me-1 text-warning"></i>Stream <span id="streamRequired"
                class="text-danger d-none">*</span>
            </label>
            <select class="form-select shadow-sm" id="stream_or_semester" name="stream_or_semester">
              <option value="">Select Stream</option>
              {% set seen_streams = [] %}
              {% for assignment in assignments %}
              {% if (assignment.class_name.startswith('11') or assignment.class_name.startswith('12')) and
              assignment.stream_or_semester and assignment.stream_or_semester not in seen_streams %}
              {% set _ = seen_streams.append(assignment.stream_or_semester) %}
              <option value="{{ assignment.stream_or_semester }}">{{ assignment.stream_or_semester }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>


          <div class="col-md-3" id="degreeField" style="display: none;">
            <label for="degree" class="form-label fw-semibold">
              <i class="fas fa-graduation-cap me-1 text-success"></i>Degree <span id="degreeRequired"
                class="text-danger d-none">*</span>
            </label>
            <select class="form-select shadow-sm" id="degree" name="degree">
              <option value="">Select Degree</option>
              {% set seen_degrees = [] %}
              {% for assignment in assignments %}
              {% if assignment.degree and assignment.degree not in seen_degrees %}
              {% set _ = seen_degrees.append(assignment.degree) %}
              <option value="{{ assignment.degree }}">{{ assignment.degree }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>


          <div class="col-md-3">
            <label for="date_display" class="form-label fw-semibold">
              <i class="fas fa-calendar-alt me-1 text-secondary"></i>Date & Time (IST) <span
                class="text-danger">*</span>
            </label>
            <input type="text" class="form-control shadow-sm" id="date_display" readonly>
            <input type="hidden" id="date" name="date" required>
          </div>


          <div class="col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-outline-primary w-100 shadow-sm" onclick="loadStudents()">
              <i class="fas fa-users me-1"></i>Load Students
            </button>
          </div>
        </div>


        <div id="studentsSection" style="display: none;">
          <div class="card border-0 shadow animate__animated animate__fadeIn">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-user-graduate me-2 text-dark"></i>Students List</h5>
              <div>
                <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="markAllPresent()">
                  <i class="fas fa-check-double me-1"></i>Mark All Present
                </button>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="markAllAbsent()">
                  <i class="fas fa-times me-1"></i>Mark All Absent
                </button>
              </div>
            </div>
            <div class="card-body bg-light">
              <div id="studentsList" class="row g-3 mt-3">

              </div>
              <div class="text-center mt-4">
                <button type="submit" id="saveBtn" class="btn btn-primary btn-lg px-5 shadow"
                  onclick="handleSubmitClick(this)">
                  <span class="spinner-border spinner-border-sm me-2 d-none" role="status" id="submitSpinner"
                    aria-hidden="true"></span>
                  <i class="fas fa-save me-2"></i>
                  <span>Save Attendance</span>
                </button>
                <script>
                  function handleSubmitClick(btn) {
                    btn.disabled = true;
                    document.getElementById('submitSpinner').classList.remove('d-none');
                    document.getElementById('attendanceForm').submit();
                  }
                </script>

              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function showFields() {
    const institutionType = "{{ institution_type }}";
    const classSelect = document.getElementById('class_name');
    const subjectField = document.getElementById('subjectField');
    const streamField = document.getElementById('streamField');
    const degreeField = document.getElementById('degreeField');
    const subjectInput = document.getElementById('subject');
    const streamInput = document.getElementById('stream_or_semester');
    const degreeInput = document.getElementById('degree');
    const subjectRequired = document.getElementById('subjectRequired');
    const streamRequired = document.getElementById('streamRequired');
    const degreeRequired = document.getElementById('degreeRequired');

    subjectField.style.display = 'none';
    streamField.style.display = 'none';
    degreeField.style.display = 'none';
    subjectInput.required = false;
    streamInput.required = false;
    degreeInput.required = false;
    subjectRequired.style.display = 'none';
    streamRequired.style.display = 'none';
    degreeRequired.style.display = 'none';

    if (institutionType === 'school') {
      if (classSelect.value.startsWith('11') || classSelect.value.startsWith('12')) {
        streamField.style.display = 'block';
        streamInput.required = true;
        streamRequired.style.display = 'inline';
      }

    } else {
      subjectField.style.display = 'block';
      degreeField.style.display = 'block';
      subjectInput.required = true;
      degreeInput.required = true;
      subjectRequired.style.display = 'inline';
      degreeRequired.style.display = 'inline';
    }
  }
  document.addEventListener('DOMContentLoaded', showFields);
  document.getElementById('class_name').addEventListener('change', showFields);

  function setISTDateTime() {
    const istDate = new Date().toLocaleString("en-GB", {
      timeZone: "Asia/Kolkata",
      hour12: false
    });

    const [datePart, timePart] = istDate.split(', ');
    const [day, month, year] = datePart.split('/');
    const [hour, minute, second] = timePart.split(':');

    const displayDateTime = `${day}-${month}-${year} ${hour}:${minute}:${second}`;
    const hiddenDateTime = `${year}-${month}-${day} ${hour}:${minute}:${second}`;

    document.getElementById('date').value = hiddenDateTime;
    document.getElementById('date_display').value = displayDateTime;
  }

  document.addEventListener('DOMContentLoaded', setISTDateTime);


  document.getElementById('class_name').addEventListener('change', function () {
    const selectedClass = this.value;
    const subjectSelect = document.getElementById('subject');
    const options = subjectSelect.querySelectorAll('option');
    subjectSelect.value = '';
    options.forEach(option => {
      if (option.value === '') {
        option.style.display = 'block';
      } else {
        option.style.display = (option.getAttribute('data-class') === selectedClass) ? 'block' : 'none';
      }
    });
    document.getElementById('studentsSection').style.display = 'none';
  });
</script>

<script>
  async function loadStudents() {
    const className = document.getElementById('class_name').value;
    const subject = document.getElementById('subject').value;
    const date = document.getElementById('date').value;
    const stream = document.getElementById('stream_or_semester')?.value || '';
    const degree = document.getElementById('degree')?.value || '';

    const institutionType = "{{ institution_type }}";
    if (!date) {
      alert('Please select the date.');
      return;
    }


    if (institutionType === 'school') {
      if (!className) {
        alert('Please select class.');
        return;
      }


      if (className.startsWith('11') || className.startsWith('12')) {
        if (!stream) {
          alert('Please select stream for class 11 or 12.');
          return;
        }
      }
    }


    if (institutionType === 'college' || institutionType === 'university') {
      if (!className || !subject || !degree) {
        alert('Please select class, subject, and degree.');
        return;
      }
    }
    try {
      const response = await fetch('{{ url_for("get_students_by_class") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          class_name: className,
          date: date,
          stream_or_semester: stream,
          degree: degree,
          subject: subject
        })
      });

      const data = await response.json();
      const students = data.students || [];

      document.getElementById('filtered_student_ids').value = JSON.stringify(students.map(s => s.id));

      if (!students.length) {
        document.getElementById('studentsSection').style.display = 'none';
        alert('No students found for this class');
        return;
      }

      let studentsHtml = `
  <div class="mb-3">
    <input type="text" id="studentSearchInput" class="form-control" placeholder="ðŸ” Search student by name or roll number...">
  </div>
  <div class="row">
`;
      students.forEach(student => {
        studentsHtml += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                           <h6 class="card-title">
  ${student.name} 
  <span class="text-muted small">(${student.roll_number || 'No Roll'})</span>
</h6>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" 
                                       name="attendance_${student.id}" value="Present" 
                                       id="present_${student.id}" checked>
                                <label class="form-check-label text-success" for="present_${student.id}">
                                    <i class="fas fa-check me-1"></i>Present
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" 
                                       name="attendance_${student.id}" value="Absent"
                                       id="absent_${student.id}">
                                <label class="form-check-label text-danger" for="absent_${student.id}">
                                    <i class="fas fa-times me-1"></i>Absent
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                `;
      });
      studentsHtml += '</div>';

      document.getElementById('studentsList').innerHTML = studentsHtml;
      document.getElementById('studentsSection').style.display = 'block';
      document.getElementById('studentSearchInput').addEventListener('input', function () {
        const val = this.value.toLowerCase();
        document.querySelectorAll('#studentsList .card').forEach(card => {
          const name = card.querySelector('.card-title').innerText.toLowerCase();
          card.parentElement.style.display = name.includes(val) ? '' : 'none';
        });
      });

    } catch (err) {
      console.error(err);
      alert('Error loading students');
    }
  }

  function markAllPresent() {
    const inputs = document.querySelectorAll('#studentsList input[type="radio"][value="Present"]');
    inputs.forEach(radio => radio.checked = true);
  }

  function markAllAbsent() {
    const inputs = document.querySelectorAll('#studentsList input[type="radio"][value="Absent"]');
    inputs.forEach(radio => radio.checked = true);
  }
</script>
{% endblock %}