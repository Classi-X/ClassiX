{% extends "base.html" %}
{% block title %}Smart Attendance | ClassiX | AI Attendance Management{% endblock %}

{% block content %}
<div class="container">
  <div class="modal fade" id="smartAttendanceHelpModal" tabindex="-1" aria-labelledby="smartAttendanceHelpLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="smartAttendanceHelpLabel">
            <i class="fas fa-circle-info me-2"></i>Smart Attendance Guide
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <h6 class="fw-bold text-secondary mb-2">üìå Overview</h6>
          <p>This page allows teachers to initiate a smart attendance session using either <strong>QR Code</strong> or
            <strong>Biometric Face Recognition</strong>. The selected session will be active for <strong>15
              minutes</strong>.
          </p>

          <hr>

          <h6 class="fw-bold text-secondary">üß≠ Steps to Start Attendance</h6>
          <ol class="ps-3">
            <li><strong>Select Attendance Mode:</strong> Choose <em>QR Code</em> or <em>Biometric Face</em>.</li>
            <li><strong>Select Class/Semester:</strong> Choose the target class from your assignments.</li>
            <li><strong>Stream:</strong> Required if class is 11 or 12 (school).</li>
            <li><strong>Subject:</strong> Required for colleges and universities.</li>
            <li><strong>Degree:</strong> Required for degree-level institutions.</li>
            <li>Click <strong>"Generate"</strong> to initiate the session.</li>
          </ol>

          <div class="alert alert-info small mt-3">
            <i class="fas fa-clock me-1"></i>
            Sessions expire automatically after 15 minutes. Students must mark attendance within that time.
          </div>

          <hr>

          <h6 class="fw-bold text-secondary">üîç Attendance Modes Explained</h6>
          <ul class="ps-3 mb-2">
            <li><strong>QR Code:</strong> A QR is generated. Students scan it in their app to mark presence.</li>
            <li><strong>Biometric Face:</strong> Face camera opens. Face must match profile photo for attendance to log.
            </li>
          </ul>

          <p class="text-muted small mb-0">
            üîê Only assigned classes and subjects will appear in dropdowns.
          </p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg mt-3 animate__animated animate__fadeIn">
        <div
          class="card-header bg-primary text-white d-flex align-items-center d-flex justify-content-between gap-2 p-2 flex-wrap">
          <h4 class="mb-0" id="dynamicHeading">
            <i class="fas fa-qrcode me-2" id="modeIcon"></i>Smart Attendance
          </h4>
          <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal"
            data-bs-target="#smartAttendanceHelpModal">
            <i class="fas fa-circle-info me-1"></i> Help
          </button>
        </div>

        <div class="card-body bg-light">
          <form method="POST">
            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="fas fa-ruler-combined me-1 text-success"></i>Set Attendance Radius (mm)
              </label>
              <div class="d-flex flex-wrap gap-2">
                <input type="number" name="attendance_radius" id="attendance_radius" class="form-control"
                  style="max-width: 150px;" placeholder="e.g., 20" required disabled>
                <button type="button" class="btn btn-outline-primary position-relative" id="startBtn"
                  onclick="startStraightMode()">
                  <span class="spinner-border spinner-border-sm me-2 d-none" id="startSpinner" role="status"></span>
                  Start
                </button>

                <button type="button" class="btn btn-outline-success position-relative" id="endBtn"
                  onclick="endStraightMode()">
                  <span class="spinner-border spinner-border-sm me-2 d-none" id="endSpinner" role="status"></span>
                  End
                </button>

              </div>
              <small class="form-text text-muted">Walk across the room to auto-calculate radius with GPS. Make sure
                you're connected to GPS/WiFi and allow location permission.</small>
              <input type="hidden" name="geo_radius" id="geo_radius">
              <input type="hidden" name="geo_center" id="geo_center">
            </div>

            <script>
              let startCoord = null;
              let endCoord = null;
              let pathPoints = [];

              function getCurrentLocation(successCallback, errorCallback) {
                if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition((pos) => {
                    const accuracy = pos.coords.accuracy;
                    const coords = {
                      lat: pos.coords.latitude,
                      lng: pos.coords.longitude
                    };
                    console.log(`üìç Got location: (${coords.lat}, ${coords.lng}) ¬±${accuracy}m`);

                    if (accuracy > 15) {
                      alert(`‚ö†Ô∏è Low GPS Accuracy: ¬±${Math.round(accuracy)} meters. Try moving near a window or outdoors.`);
                      errorCallback && errorCallback();
                      return;
                    }

                    successCallback(coords);
                  }, (err) => {
                    console.error("‚ùå Geolocation error:", err);
                    alert("Error getting location: " + err.message);
                    errorCallback && errorCallback();
                  }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                  });
                } else {
                  alert("‚ùå Geolocation is not supported by your browser.");
                  errorCallback && errorCallback();
                }
              }

              function startStraightMode() {
                const btn = document.getElementById('startBtn');
                const spinner = document.getElementById('startSpinner');
                btn.disabled = true;
                spinner.classList.remove('d-none');

                getCurrentLocation((coord) => {
                  startCoord = coord;
                  alert(`‚úÖ Start point saved at (${coord.lat}, ${coord.lng})`);
                  btn.disabled = false;
                  spinner.classList.add('d-none');
                }, () => {
                  btn.disabled = false;
                  spinner.classList.add('d-none');
                });
              }

              function endStraightMode() {
                const btn = document.getElementById('endBtn');
                const spinner = document.getElementById('endSpinner');
                btn.disabled = true;
                spinner.classList.remove('d-none');

                getCurrentLocation((coord) => {
                  endCoord = coord;
                  if (startCoord) {
                    const radius = calculateDistance(startCoord, coord) / 2;
                    const center = {
                      lat: (startCoord.lat + coord.lat) / 2,
                      lng: (startCoord.lng + coord.lng) / 2
                    };
                    updateRadiusFields(radius, center);
                    alert(`‚úÖ Radius calculated: ${Math.round(radius)} mm`);
                  } else {
                    alert("‚ö†Ô∏è Please set the start point first.");
                  }
                  btn.disabled = false;
                  spinner.classList.add('d-none');
                }, () => {
                  btn.disabled = false;
                  spinner.classList.add('d-none');
                });
              }

              function addPoint() {
                getCurrentLocation((coord) => {
                  pathPoints.push(coord);
                  alert(`‚úÖ Point added: (${coord.lat}, ${coord.lng})`);
                });
              }

              function calculatePolygonRadius() {
                if (pathPoints.length < 2) {
                  alert("‚ö†Ô∏è Add at least 2 points to calculate radius.");
                  return;
                }

                let sumLat = 0, sumLng = 0;
                pathPoints.forEach(p => {
                  sumLat += p.lat;
                  sumLng += p.lng;
                });

                const center = {
                  lat: sumLat / pathPoints.length,
                  lng: sumLng / pathPoints.length
                };

                let maxDist = 0;
                pathPoints.forEach(p => {
                  const dist = calculateDistance(p, center);
                  if (dist > maxDist) maxDist = dist;
                });

                updateRadiusFields(maxDist, center);
                alert(`‚úÖ Calculated radius from multiple points: ${Math.round(maxDist)} mm`);
              }

              function updateRadiusFields(radius, center) {
                document.getElementById('attendance_radius').value = Math.round(radius);
                document.getElementById('geo_radius').value = radius;
                document.getElementById('geo_center').value = `${center.lat},${center.lng}`;
              }

              function calculateDistance(coord1, coord2) {
                const R = 6371000;
                const dLat = toRad(coord2.lat - coord1.lat);
                const dLng = toRad(coord2.lng - coord1.lng);
                const a = Math.sin(dLat / 2) ** 2 +
                  Math.cos(toRad(coord1.lat)) * Math.cos(toRad(coord2.lat)) *
                  Math.sin(dLng / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance_m = R * c;
                return distance_m * 1000;
              }

              function toRad(deg) {
                return deg * (Math.PI / 180);
              }
            </script>

            {% if wifi_restriction_allowed %}
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="wifi_restriction" name="wifi_restriction" checked>
              <label class="form-check-label fw-semibold" for="wifi_restriction">
                Enable WiFi Restriction for this Session
              </label>
              <div class="form-text text-muted">
                Students will be able to mark attendance only if connected to the institution WiFi.
                Disable this only if the campus network is unavailable today.
              </div>
            </div>
            {% endif %}
            {% if wifi_restriction_allowed %}
            <div class="alert alert-secondary small">
              <i class="fas fa-wifi me-1"></i> Your current IP: <code>{{ request.remote_addr }}</code>
            </div>
            {% endif %}

            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="fas fa-toggle-on me-1 text-dark"></i>Select Attendance Mode <span class="text-danger">*</span>
              </label>
              <select class="form-select shadow-sm" name="mode" id="modeSelector" required>
                <option value="">Choose Mode</option>
                <option value="qr">QR Code</option>
                <option value="biometric">Biometric Face</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="class_name" class="form-label fw-semibold">
                <i class="fas fa-layer-group me-1 text-primary"></i>Class/Semester <span class="text-danger">*</span>
              </label>
              <select class="form-select shadow-sm" id="class_name" name="class_name" required>
                <option value="">Select Class/Semester</option>
                {% set class_list = [] %}
                {% for a in assignments %}
                {% if a.class_name and a.class_name not in class_list %}
                {% set _ = class_list.append(a.class_name) %}
                {% endif %}
                {% endfor %}
                {% set numeric_classes = [] %}
                {% set text_classes = [] %}
                {% for cls in class_list %}
                {% if cls.isdigit() %}
                {% set _ = numeric_classes.append(cls|int) %}
                {% else %}
                {% set _ = text_classes.append(cls) %}
                {% endif %}
                {% endfor %}
                {% for cls in numeric_classes | sort %}
                <option value="{{ cls }}">{{ cls }}</option>
                {% endfor %}
                {% for cls in text_classes | sort %}
                <option value="{{ cls }}">{{ cls }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3" id="streamField" style="display:none;">
              <label for="stream_or_semester" class="form-label fw-semibold">
                <i class="fas fa-code-branch me-1 text-warning"></i>Stream
              </label>
              <select class="form-select shadow-sm" id="stream_or_semester" name="stream_or_semester">
                <option value="">Select Stream</option>
                {% set seen_streams = [] %}
                {% for a in assignments %}
                {% if a.stream_or_semester and a.stream_or_semester not in seen_streams %}
                {% set _ = seen_streams.append(a.stream_or_semester) %}
                <option value="{{ a.stream_or_semester }}" data-class="{{ a.class_name }}">{{ a.stream_or_semester }}
                </option>
                {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="mb-3" id="subjectField" style="display:none;">
              <label for="subject" class="form-label fw-semibold">
                <i class="fas fa-book me-1 text-info"></i>Subject <span class="text-danger">*</span>
              </label>
              <select class="form-select shadow-sm" id="subject" name="subject">
                <option value="">Select Subject</option>
                {% for a in assignments %}
                {% if a.subject %}
                <option value="{{ a.subject }}" data-class="{{ a.class_name }}">{{ a.subject }}</option>
                {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="mb-3" id="degreeField" style="display:none;">
              <label for="degree" class="form-label fw-semibold">
                <i class="fas fa-graduation-cap me-1 text-success"></i>Degree *
              </label>
              <select class="form-select shadow-sm" id="degree" name="degree">
                <option value="">Select Degree</option>
                {% set seen_class_degree = [] %}
                {% for a in assignments %}
                {% if a.degree and (a.class_name ~ '|' ~ a.degree) not in seen_class_degree %}
                {% set _ = seen_class_degree.append(a.class_name ~ '|' ~ a.degree) %}
                <option value="{{ a.degree }}" data-class="{{ a.class_name }}">{{ a.degree }}</option>
                {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="alert alert-info mt-3 shadow-sm">
              <i class="fas fa-info-circle me-2"></i>
              Generated code/session will be valid for <strong>15 minutes</strong>. Students must authenticate within
              this time to mark attendance.
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-secondary shadow-sm">
                <i class="fas fa-arrow-left me-2"></i>Back
              </a>
              <button type="submit" class="btn btn-primary shadow-sm">
                <i class="fas fa-qrcode me-2" id="submitIcon"></i><span id="submitText">Generate QR Code</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const institutionType = "{{ institution_type }}";
    const classSelect = document.getElementById('class_name');
    const streamField = document.getElementById('streamField');
    const subjectField = document.getElementById('subjectField');
    const degreeField = document.getElementById('degreeField');

    const modeSelector = document.getElementById('modeSelector');
    const heading = document.getElementById('dynamicHeading');
    const modeIcon = document.getElementById('modeIcon');
    const submitText = document.getElementById('submitText');
    const submitIcon = document.getElementById('submitIcon');

    function updateHeaderAndButton(mode) {
      if (mode === 'qr') {
        heading.innerHTML = '<i class="fas fa-qrcode me-2" id="modeIcon"></i>QR Code Attendance';
        submitIcon.className = 'fas fa-qrcode me-2';
        submitText.textContent = 'Generate QR Code';
      } else if (mode === 'biometric') {
        heading.innerHTML = '<i class="fas fa-user-check me-2" id="modeIcon"></i>Biometric Face Attendance';
        submitIcon.className = 'fas fa-user-check me-2';
        submitText.textContent = 'Start Face Attendance';
      } else {
        heading.innerHTML = '<i class="fas fa-user-shield me-2" id="modeIcon"></i>Smart Attendance';
        submitIcon.className = 'fas fa-user-shield me-2';
        submitText.textContent = 'Generate Attendance';
      }
    }

    updateHeaderAndButton('');

    modeSelector.addEventListener('change', function () {
      updateHeaderAndButton(this.value);
    });

    classSelect.addEventListener('change', function () {
      const selectedClass = this.value;

      if (institutionType === 'school') {
        subjectField.style.display = 'none';
        degreeField.style.display = 'none';
        streamField.style.display = (selectedClass.startsWith('11') || selectedClass.startsWith('12')) ? 'block' : 'none';
      } else {
        streamField.style.display = 'none';
        subjectField.style.display = 'block';
        degreeField.style.display = 'block';

        document.querySelectorAll('#subject option').forEach(opt => {
          opt.style.display = opt.dataset.class === selectedClass || opt.value === '' ? 'block' : 'none';
        });
        document.querySelectorAll('#degree option').forEach(opt => {
          opt.style.display = opt.dataset.class === selectedClass || opt.value === '' ? 'block' : 'none';
        });

        document.getElementById('subject').value = '';
        document.getElementById('degree').value = '';
      }
    });
  });
</script>
{% endblock %}