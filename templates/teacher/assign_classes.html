{% extends "base.html" %}
{% block title %}Assign Classes | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}
{% block content %}
<div class="container">
  <div class="row">

    <div class="col-md-6">
      <div class="card shadow-sm border-0 mt-4 animate__animated animate__fadeInUp">
        <div class="card-header bg-light">
          <h4 class="mb-0 text-primary d-flex align-items-center">
            <i class="fas fa-chalkboard-teacher me-2"></i> Assign New Class
          </h4>
        </div>

        <div class="card-body">
          <form method="POST" id="assignForm" novalidate>
            {% if assignment_to_edit %}
            <input type="hidden" name="edit_id" value="{{ assignment_to_edit.id }}">
            {% endif %}


            <div class="mb-3">
              <label for="class_name" class="form-label fw-semibold">Class / Semester *</label>
              <select id="class_name" name="class_name" class="form-select shadow-sm" required>
                {% for c in classes %}
                <option value="{{ c }}" {% if assignment_to_edit and assignment_to_edit.class_name==c %}selected{% endif
                  %}>
                  {{ c }}
                </option>
                {% endfor %}
              </select>
            </div>


            <div class="mb-3" id="streamField" style="display: none;">
              <label for="stream_or_semester" class="form-label fw-semibold">Stream</label>
              <select id="stream_or_semester" name="stream_or_semester" class="form-select shadow-sm">
                <option value="">-- Select Stream --</option>
                {% for s in streams %}
                <option value="{{ s }}" {% if assignment_to_edit and assignment_to_edit.stream_or_semester==s
                  %}selected{% endif %}>
                  {{ s }}
                </option>
                {% endfor %}
              </select>
            </div>


            <div class="mb-3" id="subjectField" style="display: none;">
              <label for="subject" class="form-label fw-semibold">Subject</label>
              <input type="text" id="subject" name="subject" class="form-control shadow-sm" list="subjectList"
                placeholder="e.g., Physics â€“ Computer Engineering"
                value="{{ assignment_to_edit.subject if assignment_to_edit else '' }}">
              <datalist id="subjectList">
                {% for subj in all_subjects %}
                <option value="{{ subj }}">
                  {% endfor %}
              </datalist>
              <small class="form-text text-muted">Enter subject as <strong>Subject â€“ Branch</strong> (e.g., Physics â€“
                Computer Engineering). See below for full instructions.</small>

            </div>


            <div class="mb-3" id="degreeField" style="display: none;">
              <label for="degree" class="form-label fw-semibold">Degree</label>
              <select id="degree" name="degree" class="form-select shadow-sm">
                <option value="">-- Select Degree --</option>
                {% for d in degrees %}
                <option value="{{ d }}" {% if assignment_to_edit and assignment_to_edit.degree==d %}selected{% endif %}>
                  {{ d }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
              <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
              </a>
              <button type="submit" id="submitBtn" class="btn btn-primary shadow-sm" disabled>
                <i class="fas fa-plus me-2"></i>
                {% if assignment_to_edit %}Update{% else %}Assign Class{% endif %}
              </button>
            </div>
            <div class="mb-3" id="subjectIns" style="display: none;">
              <div class="alert alert-info mt-2 py-3 px-4 rounded-3 border-start border-4 border-primary" role="alert">
                <h6 class="fw-bold text-primary mb-2">
                  How to write the subject properly:
                </h6>

                <p class="mb-2">
                  In many degree programs (like Engineering, B.Sc., BBA, Pharmacy, etc.), the same subject may be taught
                  across different
                  <strong>branches or specializations</strong>. To avoid confusion and manage data accurately, please
                  use the following format:
                </p>

                <p class="mb-2">
                  <strong class="text-dark">Subject Name â€“ Branch/Specialization</strong>
                </p>

                <ul class="mb-2 ps-4">
                  <li><span class="text-dark">Physics â€“ Computer Engineering</span></li>
                  <li><span class="text-dark">Mathematics â€“ IT</span></li>
                  <li><span class="text-dark">Business Communication â€“ Marketing</span></li>
                  <li><span class="text-dark">Organic Chemistry â€“ Pharmaceutical Sciences</span></li>
                  <li><span class="text-dark">Psychology â€“ Clinical Psychology</span></li>
                </ul>

                <p class="mb-2 text-secondary">
                  <strong>When should you write only the subject name?</strong><br>
                  If your institution does <u>not</u> use branches/specializations (e.g., a college or general program),
                  you can simply write:
                </p>

                <ul class="mb-2 ps-4">
                  <li><span class="text-dark">Mathematics</span></li>
                  <li><span class="text-dark">English</span></li>
                  <li><span class="text-dark">Science</span></li>
                </ul>

                <p class="mb-0 text-secondary">
                  <strong>Tip:</strong> Use correct spelling and full names to ensure consistency across records.
                </p>
              </div>

            </div>

          </form>
        </div>
      </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const classSelect = document.getElementById('class_name');
        const submitBtn = document.getElementById('submitBtn');

        classSelect.addEventListener('change', () => {
          submitBtn.disabled = !classSelect.value;
        });


        submitBtn.disabled = !classSelect.value;
      });
    </script>
    <div class="modal fade" id="assignClassHelpModal" tabindex="-1" aria-labelledby="assignClassHelpModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-sm">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="assignClassHelpModalLabel">
              <i class="fas fa-info-circle me-2"></i> Assign Class â€“ Instructions
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <h6 class="fw-semibold mb-2">ðŸŽ“ Class/Semester</h6>
            <ul>
              <li>Select the appropriate class/semester from the dropdown.</li>
              <li>For schools, this can be grades like "10", "11", "12".</li>
              <li>For colleges/universities, it could be "1", "2", "3", etc.</li>
            </ul>

            <hr class="my-3">

            <h6 class="fw-semibold mb-2">ðŸ§­ Stream</h6>
            <ul>
              <li>Visible only if selected class is <strong>11</strong> or <strong>12</strong> (for schools).</li>
              <li>Examples: Science, Commerce, Arts, etc.</li>
            </ul>

            <hr class="my-3">

            <h6 class="fw-semibold mb-2">ðŸ“š Subject</h6>
            <p>Enter the subject in the following format for clarity:</p>
            <ul class="mb-2 ps-4">
              <li><strong>Subject â€“ Branch</strong> (e.g., <em>Physics â€“ Mechanical Engineering</em>)</li>
              <li><strong>Business Law â€“ BBA</strong></li>
              <li><strong>Organic Chemistry â€“ B.Pharm</strong></li>
            </ul>
            <p class="text-muted">If no specialization is needed, enter just the subject (e.g.,
              <strong>English</strong>).</p>

            <hr class="my-3">

            <h6 class="fw-semibold mb-2">ðŸŽ“ Degree</h6>
            <ul>
              <li>Only applicable for college/university setups.</li>
              <li>Select the degree like B.Sc., BBA, B.Tech, etc.</li>
            </ul>

            <hr class="my-3">

            <h6 class="fw-semibold mb-2">ðŸ’¡ Tips</h6>
            <ul>
              <li>Use consistent spellings to avoid duplicate records.</li>
              <li>Make sure subject names are not abbreviated unless universally accepted.</li>
            </ul>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i> Close
            </button>
          </div>
        </div>
      </div>
    </div>


    <div class="col-md-6">
      <div class="card shadow-sm border-0 mt-4 animate__animated animate__fadeInUp">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
          <h5 class="mb-0 text-primary d-flex align-items-center">
            <i class="fas fa-list me-2"></i> Current Assignments
          </h5>
        </div>

        <div class="card-body">
          {% if assignments %}

          <div class="mb-3">
            <input type="text" id="assignmentSearchInput" class="form-control form-control-sm shadow-sm"
              placeholder="ðŸ” Search by class, subject, degree, stream..." oninput="filterAssignments()">
          </div>


          <div class="table-responsive">
            <div class="d-flex justify-content-end gap-2 p-2 flex-wrap">
              <button id="downloadCSV" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-download me-1"></i> Download CSV
              </button>
              <button class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal"
                data-bs-target="#assignClassHelpModal">
                <i class="fas fa-circle-info me-1"></i> Help
              </button>

            </div>
            <script>
              document.getElementById('downloadCSV').addEventListener('click', function () {
                const table = document.getElementById('assignmentTable');
                const allRows = table.querySelectorAll('thead tr, tbody tr');
                let csv = [];

                allRows.forEach(row => {
                  if (row.offsetParent !== null) {
                    const cols = row.querySelectorAll('th, td');
                    const rowData = [];
                    cols.forEach(col => {
                      let text = col.innerText.trim().replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                      rowData.push(`"${text}"`);
                    });
                    csv.push(rowData.join(','));
                  }
                });

                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'assignments.csv';
                a.click();
                URL.revokeObjectURL(url);
              });
            </script>

            <table class="table table-hover align-middle mb-0" id="assignmentTable">
              <thead class="table-light text-center">
                <tr>
                  <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>
                  {% if institution_type != 'school' %}
                  <th><i class="fas fa-book-open me-1"></i> Subject</th>
                  <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                  {% else %}
                  {% set show_stream = assignments | selectattr("class_name") | map(attribute="class_name") | list |
                  select("string") | list %}
                  {% set show_stream = show_stream | select("string") | list %}
                  {% set show_stream = show_stream | list %}

                  {% if show_stream %}
                  <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                  {% endif %}
                  {% endif %}
                  <th><i class="fas fa-cogs me-1"></i> Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for assignment in assignments %}
                <tr>
                  <td class="text-center">
                    <span class="badge bg-primary">{{ assignment.class_name }}</span>
                  </td>

                  {% if institution_type != 'school' %}
                  <td>{{ assignment.subject or '-' }}</td>
                  <td>{{ assignment.degree or '-' }}</td>
                  {% else %}
                  {% if show_stream %}
                  <td>{{ assignment.stream_or_semester or '-' }}</td>
                  {% else %}
                  <td>-</td>
                  {% endif %}
                  {% endif %}

                  <td class="text-center">
                    <a href="{{ url_for('assign_classes', edit=assignment.id) }}"
                      class="btn btn-sm btn-outline-primary me-1" title="Edit">
                      <i class="fas fa-pen"></i>
                    </a>
                    <a href="{{ url_for('assign_classes', delete=assignment.id) }}"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Are you sure you want to delete this assignment?');" title="Delete">
                      <i class="fas fa-trash-alt"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}

          <div class="text-center py-5">
            <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3 animate__animated animate__fadeInDown"></i>
            <p class="text-muted">No class assignments yet.</p>
          </div>
          {% endif %}
        </div>


        <script>
          function filterAssignments() {
            const input = document.getElementById('assignmentSearchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#assignmentTable tbody tr');

            rows.forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(input) ? '' : 'none';
            });
          }
        </script>
      </div>
    </div>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const institutionType = "{{ institution_type }}";
    const classSelect = document.getElementById('class_name');
    const streamField = document.getElementById('streamField');
    const subjectField = document.getElementById('subjectField');
    const subjectIns = document.getElementById('subjectIns');
    const degreeField = document.getElementById('degreeField');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('assignForm');


    if (institutionType === 'school') {
      subjectField.style.display = 'none';
      subjectIns.style.display = 'none';
      degreeField.style.display = 'none';
    } else {
      streamField.style.display = 'none';
      subjectField.style.display = 'block';
      subjectIns.style.display = 'block';
      degreeField.style.display = 'block';
    }


    if (institutionType === 'school') {
      classSelect.addEventListener('change', function () {
        if (classSelect.value.startsWith("11") || classSelect.value.startsWith("12")) {
          streamField.style.display = 'block';
        }
        else {
          streamField.style.display = 'none';
        }
        validateForm();
      });
    }

    function validateForm() {
      const classValue = classSelect.value;
      const subjectValue = document.getElementById('subject')?.value.trim();
      const streamValue = document.getElementById('stream_or_semester')?.value.trim();
      const degreeValue = document.getElementById('degree')?.value.trim();

      let isValid = false;

      if (institutionType === 'school') {

        if (classValue) {
          if (classValue.startsWith("11") || classValue.startsWith("12")) {
            isValid = streamValue !== '';
          } else {

            isValid = true;
          }
        }
      } else {

        if (classValue && subjectValue && degreeValue) {
          isValid = true;
        }
      }

      submitBtn.disabled = !isValid;
    }


    form.addEventListener('input', validateForm);
    form.addEventListener('change', validateForm);
    validateForm();
  });
</script>
{% endblock %}