{% extends "base.html" %}
{% block title %}Assign Classes | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}
{% block content %}
<div class="container">
  <div class="row">

    <div class="col-md-6">
      <div class="card shadow-sm border-0 mt-4 animate__animated animate__fadeInUp">
        <div class="card-header bg-light">
          <h4 class="mb-0 text-primary d-flex align-items-center">
            <i class="fas fa-chalkboard-teacher me-2"></i> Assign New Class
          </h4>
        </div>

        <div class="card-body">
          <form method="POST" id="assignForm" novalidate>
            {% if assignment_to_edit %}
            <input type="hidden" name="edit_id" value="{{ assignment_to_edit.id }}">
            {% endif %}


            <div class="mb-3">
              <label for="class_name" class="form-label fw-semibold">Class / Semester *</label>
              <select id="class_name" name="class_name" class="form-select shadow-sm" required>
                {% for c in classes %}
                <option value="{{ c }}" {% if assignment_to_edit and assignment_to_edit.class_name==c %}selected{% endif
                  %}>
                  {{ c }}
                </option>
                {% endfor %}
              </select>
            </div>


            <div class="mb-3" id="streamField" style="display: none;">
              <label for="stream_or_semester" class="form-label fw-semibold">Stream</label>
              <select id="stream_or_semester" name="stream_or_semester" class="form-select shadow-sm">
                <option value="">-- Select Stream --</option>
                {% for s in streams %}
                <option value="{{ s }}" {% if assignment_to_edit and assignment_to_edit.stream_or_semester==s
                  %}selected{% endif %}>
                  {{ s }}
                </option>
                {% endfor %}
              </select>
            </div>


            <div class="mb-3" id="subjectField" style="display: none;">
              <label for="subject" class="form-label fw-semibold">Subject</label>
              <input type="text" id="subject" name="subject" class="form-control shadow-sm" list="subjectList"
                placeholder="e.g., Mathematics" value="{{ assignment_to_edit.subject if assignment_to_edit else '' }}">
              <datalist id="subjectList">
                {% for subj in all_subjects %}
                <option value="{{ subj }}">
                  {% endfor %}
              </datalist>

            </div>


            <div class="mb-3" id="degreeField" style="display: none;">
              <label for="degree" class="form-label fw-semibold">Degree</label>
              <select id="degree" name="degree" class="form-select shadow-sm">
                <option value="">-- Select Degree --</option>
                {% for d in degrees %}
                <option value="{{ d }}" {% if assignment_to_edit and assignment_to_edit.degree==d %}selected{% endif %}>
                  {{ d }}
                </option>
                {% endfor %}
              </select>
            </div>


            <div class="d-flex justify-content-between align-items-center mt-4">
              <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
              </a>
              <button type="submit" id="submitBtn" class="btn btn-primary shadow-sm" disabled>
                <i class="fas fa-plus me-2"></i>
                {% if assignment_to_edit %}Update{% else %}Assign Class{% endif %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const classSelect = document.getElementById('class_name');
        const submitBtn = document.getElementById('submitBtn');

        classSelect.addEventListener('change', () => {
          submitBtn.disabled = !classSelect.value;
        });


        submitBtn.disabled = !classSelect.value;
      });
    </script>


    <div class="col-md-6">
      <div class="card shadow-sm border-0 mt-4 animate__animated animate__fadeInUp">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
          <h5 class="mb-0 text-primary d-flex align-items-center">
            <i class="fas fa-list me-2"></i> Current Assignments
          </h5>
        </div>

        <div class="card-body">
          {% if assignments %}

          <div class="mb-3">
            <input type="text" id="assignmentSearchInput" class="form-control form-control-sm shadow-sm"
              placeholder="ðŸ” Search by class, subject, degree, stream..." oninput="filterAssignments()">
          </div>


          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="assignmentTable">
              <thead class="table-light text-center">
                <tr>
                  <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>
                  {% if institution_type != 'school' %}
                  <th><i class="fas fa-book-open me-1"></i> Subject</th>
                  <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                  {% else %}
                  {% set show_stream = assignments | selectattr("class_name", "in", ["11", "12"]) | list | length > 0 %}
                  {% if show_stream %}
                  <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                  {% endif %}
                  {% endif %}
                  <th><i class="fas fa-cogs me-1"></i> Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for assignment in assignments %}
                <tr>
                  <td class="text-center">
                    <span class="badge bg-primary">{{ assignment.class_name }}</span>
                  </td>

                  {% if institution_type != 'school' %}
                  <td>{{ assignment.subject or '-' }}</td>
                  <td>{{ assignment.degree or '-' }}</td>
                  {% else %}
                  {% if show_stream %}
                  {% if assignment.class_name in ['11', '12'] %}
                  <td>{{ assignment.stream_or_semester or '-' }}</td>
                  {% else %}
                  <td>-</td>
                  {% endif %}
                  {% endif %}
                  {% endif %}

                  <td class="text-center">
                    <a href="{{ url_for('assign_classes', edit=assignment.id) }}"
                      class="btn btn-sm btn-outline-primary me-1" title="Edit">
                      <i class="fas fa-pen"></i>
                    </a>
                    <a href="{{ url_for('assign_classes', delete=assignment.id) }}"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Are you sure you want to delete this assignment?');" title="Delete">
                      <i class="fas fa-trash-alt"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}

          <div class="text-center py-5">
            <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3 animate__animated animate__fadeInDown"></i>
            <p class="text-muted">No class assignments yet.</p>
          </div>
          {% endif %}
        </div>


        <script>
          function filterAssignments() {
            const input = document.getElementById('assignmentSearchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#assignmentTable tbody tr');

            rows.forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(input) ? '' : 'none';
            });
          }
        </script>
      </div>
    </div>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const institutionType = "{{ institution_type }}";
    const classSelect = document.getElementById('class_name');
    const streamField = document.getElementById('streamField');
    const subjectField = document.getElementById('subjectField');
    const degreeField = document.getElementById('degreeField');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('assignForm');


    if (institutionType === 'school') {
      subjectField.style.display = 'none';
      degreeField.style.display = 'none';
    } else {
      streamField.style.display = 'none';
      subjectField.style.display = 'block';
      degreeField.style.display = 'block';
    }


    if (institutionType === 'school') {
      classSelect.addEventListener('change', function () {
        if (['11', '12'].includes(classSelect.value)) {
          streamField.style.display = 'block';
        } else {
          streamField.style.display = 'none';
        }
        validateForm();
      });
    }

    function validateForm() {
      const classValue = classSelect.value;
      const subjectValue = document.getElementById('subject')?.value.trim();
      const streamValue = document.getElementById('stream_or_semester')?.value.trim();
      const degreeValue = document.getElementById('degree')?.value.trim();

      let isValid = false;

      if (institutionType === 'school') {

        if (classValue) {
          if (['11', '12'].includes(classValue)) {

            isValid = streamValue !== '';
          } else {

            isValid = true;
          }
        }
      } else {

        if (classValue && subjectValue && degreeValue) {
          isValid = true;
        }
      }

      submitBtn.disabled = !isValid;
    }


    form.addEventListener('input', validateForm);
    form.addEventListener('change', validateForm);
    validateForm();
  });
</script>
{% endblock %}