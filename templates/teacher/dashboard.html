{% extends "base.html" %}

{% block title %}Teacher Dashboard | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div
      class="d-md-none bg-gradient bg-primary text-white d-flex justify-content-between align-items-center px-4 py-3 shadow-sm rounded-bottom animate__animated animate__fadeInDown">
      <div class="d-flex align-items-center">
        <i class="fas fa-chart-line fs-4 me-2"></i>
        <h5 class="mb-0 fw-semibold">Dashboard</h5>
      </div>
      <button
        class="btn btn-light btn-sm rounded-circle shadow-sm d-flex align-items-center justify-content-center transition"
        onclick="toggleSidebar()" aria-label="Toggle Sidebar">
        <i class="fas fa-bars text-primary fs-5"></i>
      </button>
    </div>

    <style>
      .transition {
        transition: all 0.3s ease-in-out;
      }

      .btn-light:hover {
        background-color: #e2e6ea;
        transform: scale(1.05);
      }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('d-none');
        sidebar.classList.toggle('d-block');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const blinkArea = document.getElementById('blinkArea');

        async function checkNewChats() {
          try {
            const res = await fetch('/chat/has-new');
            const data = await res.json();
            blinkArea.classList.toggle('blinking', data.new_message);
          } catch (err) {
            console.error("Error checking chat notifications", err);
          }
        }

        checkNewChats();
        setInterval(checkNewChats, 10000);
      });
    </script>


    <div id="sidebar"
      class="col-md-3 col-lg-2 bg-white border-end shadow-sm p-0 sidebar-collapse d-none d-md-block animate__animated animate__fadeInLeft">
      <nav class="list-group list-group-flush rounded-0 py-3">

        <a href="{{ url_for('teacher_dashboard') }}"
          class="d-none d-md-inline list-group-item list-group-item-action active d-flex align-items-center">
          <i class="fas fa-tachometer-alt me-2"></i> Dashboard
        </a>


        <a href="{{ url_for('assign_classes') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-chalkboard-teacher me-2"></i> Assign Classes
        </a>

        <a href="{{ url_for('mark_attendance') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-check-circle me-2"></i> Mark Attendance
        </a>

        <a href="{{ url_for('generate_qr') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-shield me-2"></i> Smart Attendance
        </a>
        {% if current_user.institution.type.lower() == 'school' %}
        <a href="{{ url_for('add_students') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-plus me-2"></i> Add Students
        </a>
        {% endif %}


        <a href="{{ url_for('qr_method_selector') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-cogs me-2 text-primary"></i> QR Method Selector
        </a>

        <a href="{{ url_for('qr_persistent') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-infinity me-2 text-dark"></i> Persistent QR
        </a>

        <a href="{{ url_for('qr_rotating') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-sync-alt me-2 text-success"></i> Rotating QR
        </a>

        <a href="{{ url_for('parent_status') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-friends me-2"></i> Parent Status
        </a>

        <a href="{{ url_for('attendance_records') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-clipboard-list me-2"></i> Attendance Records
        </a>

        <a href="{{ url_for('students_in_class') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-users me-2"></i> Students in Class
        </a>

        <a href="{{ url_for('teacher_list') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-chalkboard-teacher me-2"></i> Teacher Directory
        </a>

        <a href="{{ url_for('student_list') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-graduate me-2"></i> Student Directory
        </a>

        <a href="{{ url_for('view_own_profile') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user me-2"></i> Profile
        </a>

        <a href="{{ url_for('logout') }}" class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>


        <a href="{{ url_for('chat_history') }}"
          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center position-relative"
          id="myChatsLink">
          <div class="d-flex align-items-center blink-area" id="blinkArea">
            <i class="fas fa-comments me-2"></i>
            <span>My Chats</span>
          </div>
        </a>


        <a href="{{ url_for('about') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-info-circle me-2"></i> About Us
        </a>

        <a href="{{ url_for('contact') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-envelope me-2"></i> Contact
        </a>

        <a href="/chat/1" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-shield me-2"></i> Chat SuperAdmin
        </a>


        <a href="{{ url_for('terms') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-file-contract me-2"></i> Terms & Conditions
        </a>

        <a href="{{ url_for('privacy') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-shield-alt me-2"></i> Privacy Policy
        </a>
        <a href="{{ url_for('faq') }}" class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-question-circle me-2"></i>FAQ
        </a>
        <a href="{{ url_for('ai_chat') }}" class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-robot me-2"></i>AI ChatBot
        </a>
        <a href="https://drive.google.com/file/d/10ZYBlKShXjY0F4MF3LTZCJfMrYl3Eryz/view?usp=sharing"
          class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-chalkboard-teacher me-2"></i>Teacher User Manual
        </a>

      </nav>


      <style>
        .blink-area.blinking {
          color: #dc3545 !important;
          animation: blinkRed 1.2s ease-in-out infinite;
          font-weight: 600;
        }

        .blink-area.blinking i {
          color: #dc3545 !important;
        }

        @keyframes blinkRed {

          0%,
          100% {
            opacity: 1;
            text-shadow: 0 0 5px rgba(220, 53, 69, 0.6);
          }

          50% {
            opacity: 0.4;
            text-shadow: 0 0 10px rgba(220, 53, 69, 0.9);
          }
        }
      </style>


      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const blinkArea = document.getElementById('blinkArea');
          async function checkNewChats() {
            try {
              const res = await fetch('/chat/has-new');
              const data = await res.json();
              blinkArea.classList.toggle('blinking', data.new_message);
            } catch (err) {
              console.error("Error checking chat notifications", err);
            }
          }
          checkNewChats();
          setInterval(checkNewChats, 10000);
        });
      </script>

    </div>

    <div class="modal fade" id="dashboardHelpModal" tabindex="-1" aria-labelledby="dashboardHelpModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="dashboardHelpModalLabel">
              <i class="fas fa-circle-info me-2"></i> Dashboard Guide
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h6 class="fw-bold text-secondary mb-2">üìä What‚Äôs on this page?</h6>
            <ul class="ps-3 mb-3">
              <li><strong>Classes Assigned:</strong> Total number of classes currently assigned to you.</li>
              <li><strong>Pending Approvals:</strong> Students awaiting approval in your classes.</li>
              <li><strong>Subjects Taught:</strong> Count of unique subject + class combinations assigned to you.</li>
              <li><strong>At Risk Students:</strong> Students with low or declining attendance in your classes.</li>
            </ul>

            <hr>

            <h6 class="fw-bold text-secondary mb-2">üîç What does "At Risk" mean?</h6>
            <p class="mb-2">
              These are students whose attendance is currently <strong>below 75%</strong> or is dropping over time.
            </p>
            <ul class="ps-3 mb-3">
              <li>Below 75% ‚Üí Monitored</li>
              <li>Below 60% ‚Üí <span class="text-danger fw-semibold">High Risk</span></li>
            </ul>

            <hr>

            <h6 class="fw-bold text-secondary mb-2">üí° Tips</h6>
            <ul class="ps-3">
              <li>Click any stat card to drill into more details (if enabled).</li>
              <li>Use the sidebar to access attendance, reports, or student management.</li>
              <li>Come back here anytime to track your classroom activity at a glance.</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i> Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-9 col-lg-10">

      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4 border-bottom border-primary-subtle animate__animated animate__fadeInDown">
        <h1 style="padding-bottom: 10px;" class="h3 fw-bold text-primary d-flex align-items-center mb-0">
          <i class="fas fa-chalkboard-teacher me-2"></i> Teacher Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary shadow-sm" data-bs-toggle="modal"
              data-bs-target="#dashboardHelpModal">
              <i class="fas fa-circle-info me-1"></i> Help
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary shadow-sm">
              <i class="fas fa-calendar-alt me-2"></i> {{ current_month_year }}
            </button>
          </div>
        </div>
      </div>


      <div class="row g-4">

        <div class="col-sm-6 col-md-3">
          <div
            class="card shadow-sm border-0 text-white bg-gradient bg-primary h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">Classes Assigned</h6>
                <h3 class="mb-0">{{ assignments|length }}</h3>
              </div>
              <i class="fas fa-chalkboard-teacher fa-2x opacity-75"></i>
            </div>
          </div>
        </div>


        <div class="col-sm-6 col-md-3">
          <div class="card shadow-sm border-0 text-white bg-gradient bg-info h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">Pending Approvals</h6>
                <h3 class="mb-0">{{ pending_students|length }}</h3>
              </div>
              <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
          </div>
        </div>


        <div class="col-sm-6 col-md-3">
          <div
            class="card shadow-sm border-0 text-white bg-gradient bg-success h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">Subjects Taught</h6>
                <h3 class="mb-0">{{ insights.teacher_stats.classes_taught }}</h3>
              </div>
              <i class="fas fa-book fa-2x opacity-75"></i>
            </div>
          </div>
        </div>


        <div class="col-sm-6 col-md-3">
          <div
            class="card shadow-sm border-0 text-white bg-gradient bg-warning h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">At Risk Students</h6>
                <h3 class="mb-0">{{ insights.at_risk_in_classes|length }}</h3>
              </div>
              <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>

      <style>
        .card {
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          border-radius: 0.75rem;
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
        }

        h6 {
          letter-spacing: 0.5px;
        }
      </style>

      <div class="modal fade" id="assignedClassesHelpModal" tabindex="-1" aria-labelledby="assignedClassesHelpLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content shadow border-0">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="assignedClassesHelpLabel">
                <i class="fas fa-circle-info me-2"></i> Assigned Classes Instructions
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
            <div class="modal-body">

              <p>This section shows all the classes and subjects currently assigned to you.</p>

              <h6 class="fw-bold text-secondary mt-3">üîç Key Columns:</h6>
              <ul class="ps-3">
                <li><strong>Class/Semester:</strong> The academic group assigned to you.</li>
                {% if institution_type == 'school' %}
                <li><strong>Stream:</strong> For higher secondary school classes (11/12), stream is shown.</li>
                {% else %}
                <li><strong>Subject & Degree:</strong> Your subject and its corresponding program (e.g., B.Sc., B.Tech).
                </li>
                {% endif %}
                <li><strong>Assigned Date:</strong> Date on which the class was officially assigned.</li>
                <li><strong>Actions:</strong> Use the <em>Mark Attendance</em> button if attendance hasn't been taken
                  today.</li>
              </ul>

              <h6 class="fw-bold text-secondary mt-4">üì• CSV Export:</h6>
              <p>You can click <strong>Download CSV</strong> to export all assigned class details for offline use.</p>

              <h6 class="fw-bold text-secondary mt-4">üß† Tips:</h6>
              <ul class="ps-3">
                <li>Use the search bar to quickly filter by class, subject, stream, or degree.</li>
                <li>If no classes are assigned, click the <strong>Assign New</strong> button to get started.</li>
              </ul>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div
              class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
              <h5 class="mb-0 text-secondary d-flex align-items-center">
                <i class="fas fa-chalkboard-teacher me-2 text-primary"></i> My Assigned Classes
              </h5>
              <a href="{{ url_for('assign_classes') }}" class="btn btn-sm btn-primary shadow-sm">
                <i class="fas fa-plus me-1"></i> Assign New Class/Semester
              </a>
            </div>

            <div class="card-body">
              {% if assignments %}

              <div class="mb-4">
                <input type="text" id="assignmentSearchInput" class="form-control form-control-sm"
                  placeholder="üîç Search by class, subject, stream, or degree..." oninput="filterAssignments()">
              </div>

              <style>
                #assignmentTable thead th {
                  position: sticky;
                  top: 0;
                  background: #f8f9fa;
                  z-index: 1;
                }
              </style>
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <div class="d-flex justify-content-end gap-2 p-2 flex-wrap">
                  <button id="downloadssCSV" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download me-1"></i> Download CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#assignedClassesHelpModal">
                    <i class="fas fa-circle-info me-1"></i> Instructions
                  </button>
                </div>
                <script>
                  document.getElementById('downloadssCSV').addEventListener('click', function () {
                    const table = document.getElementById('assignmentTable');
                    const allRows = table.querySelectorAll('thead tr, tbody tr');
                    let csv = [];

                    allRows.forEach(row => {
                      if (row.offsetParent !== null) {
                        const cols = row.querySelectorAll('th, td');
                        const rowData = [];
                        cols.forEach(col => {
                          let text = col.innerText.trim().replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                          rowData.push(`"${text}"`);
                        });
                        csv.push(rowData.join(','));
                      }
                    });

                    const csvContent = csv.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'assignments.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                  });
                </script>

                <table class="table table-hover align-middle" id="assignmentTable">
                  <thead class="table-light">
                    <tr>
                      <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>
                      {% set has_11_12 = [] %}
                      {% for a in assignments %}
                      {% if a.class_name.startswith('11') or a.class_name.startswith('12') %}
                      {% set _ = has_11_12.append(1) %}
                      {% endif %}
                      {% endfor %}

                      {% if institution_type == 'school' and has_11_12 %}
                      <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                      {% endif %}

                      {% if institution_type != 'school' %}
                      <th><i class="fas fa-book-open me-1"></i> Subject</th>
                      <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                      {% endif %}
                      <th><i class="fas fa-calendar-day me-1"></i> Assigned Date</th>
                      <th><i class="fas fa-cogs me-1"></i> Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for assignment in assignments %}
                    <tr>
                      <td><span class="badge bg-primary">{{ assignment.class_name }}</span></td>

                      {% if institution_type == 'school' and has_11_12 %}
                      {% if assignment.class_name.startswith('11') or assignment.class_name.startswith('12') %}
                      <td>{{ assignment.stream_or_semester or '-' }}</td>
                      {% else %}
                      <td>-</td>
                      {% endif %}
                      {% endif %}

                      {% if institution_type != 'school' %}
                      <td>{{ assignment.subject }}</td>
                      <td>{{ assignment.degree or '-' }}</td>
                      {% endif %}

                      <td>{{ assignment.created_at.strftime('%Y-%m-%d') }}</td>
                      <td>
                        {% set pair = (assignment.class_name, assignment.subject) %}
                        {% if pair in marked_today_pairs %}
                        <span class="badge bg-success text-white">
                          <i class="fas fa-check-circle me-1"></i> Attendance marked
                        </span>
                        {% else %}
                        <a href="{{ url_for('mark_attendance') }}?class={{ assignment.class_name }}&subject={{ assignment.subject }}"
                          class="btn btn-sm btn-outline-success">
                          <i class="fas fa-check-circle me-1"></i> Mark Attendance
                        </a>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              {% else %}

              <div class="text-center py-5">
                <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3 animate__animated animate__fadeInDown"></i>
                <p class="text-muted">No classes assigned yet.</p>
                <a href="{{ url_for('assign_classes') }}" class="btn btn-primary shadow-sm">
                  <i class="fas fa-plus me-2"></i> Assign Your First Class
                </a>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterAssignments() {
          const input = document.getElementById('assignmentSearchInput').value.toLowerCase().trim();
          const rows = document.querySelectorAll('#assignmentTable tbody tr');
          rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
          });
        }
      </script>
      <div class="modal fade" id="subjectPerformanceHelpModal" tabindex="-1"
        aria-labelledby="subjectPerformanceHelpLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content shadow border-0">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="subjectPerformanceHelpLabel">
                <i class="fas fa-circle-info me-2"></i> Subject Performance Instructions
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
            <div class="modal-body">

              <p>This section gives a visual summary of student attendance by subject.</p>

              <h6 class="fw-bold text-secondary mt-3">üìä What you see:</h6>
              <ul class="ps-3">
                <li><strong>Subject Name:</strong> Displayed at the top of each card.</li>
                <li><strong>Progress Bar:</strong> Indicates average attendance percentage of students in that subject.
                </li>
                <li><strong>Color Code:</strong></li>
                <ul>
                  <li><span class="badge bg-success">Green</span>: 75% and above</li>
                  <li><span class="badge bg-warning text-dark">Yellow</span>: 60%‚Äì74%</li>
                  <li><span class="badge bg-danger">Red</span>: Below 60%</li>
                </ul>
                <li><strong>Student Count:</strong> Number of students currently enrolled in the subject.</li>
              </ul>

              <h6 class="fw-bold text-secondary mt-4">üîç Using Search:</h6>
              <p>Use the search box above the cards to quickly locate a specific subject.</p>

              <h6 class="fw-bold text-secondary mt-4">üß† Tips:</h6>
              <ul class="ps-3">
                <li>Use this data to identify which subjects need more attendance focus.</li>
                <li>Click on student records elsewhere in the dashboard to take action where needed.</li>
              </ul>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Close
              </button>
            </div>
          </div>
        </div>
      </div>

      {% if insights.subject_performance %}
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div
              class="card-header bg-light d-flex align-items-center d-flex justify-content-between gap-2 p-2 flex-wrap">
              <h5 class="mb-0 text-primary d-flex align-items-center">
                <i class="fas fa-chart-bar me-2"></i> Subject Performance
              </h5>
              <button class="btn btn-sm btn-outline-secondary shadow-sm" data-bs-toggle="modal"
                data-bs-target="#subjectPerformanceHelpModal">
                <i class="fas fa-circle-info me-1"></i> Instructions
              </button>
            </div>

            <div class="card-body">

              <div class="mb-4">
                <input type="text" id="subjectSearchInput" class="form-control form-control-sm"
                  placeholder="üîç Search subjects..." oninput="filterSubjectPerformance()">
              </div>

              <div class="row g-3" id="subjectPerformanceContainer">
                {% for subject, stats in insights.subject_performance.items() %}
                <div class="col-sm-6 col-md-4 subject-card">
                  <div class="card h-100 shadow-sm border-0 bg-light animate__animated animate__fadeIn">
                    <div class="card-body">
                      <h6 class="card-title fw-semibold text-secondary mb-3 d-flex align-items-center">
                        <i class="fas fa-book-open me-2 text-info"></i> {{ subject }}
                      </h6>

                      <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-{{
                      'success' if stats.average_attendance >= 75 else
                      'warning' if stats.average_attendance >= 60 else
                      'danger'
                    }}" style="width: {{ stats.average_attendance }}%">
                          {{ stats.average_attendance }}%
                        </div>
                      </div>

                      <small class="text-muted d-block">
                        <i class="fas fa-users me-1"></i> {{ stats.student_count }} students
                      </small>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterSubjectPerformance() {
          const input = document.getElementById("subjectSearchInput").value.toLowerCase().trim();
          const cards = document.querySelectorAll("#subjectPerformanceContainer .subject-card");

          cards.forEach(card => {
            const title = card.querySelector(".card-title").textContent.toLowerCase();
            if (title.includes(input)) {
              card.classList.remove("d-none");
            } else {
              card.classList.add("d-none");
            }
          });
        }
      </script>




      {% endif %}

      <div class="modal fade" id="pendingApprovalHelpModal" tabindex="-1" aria-labelledby="pendingApprovalHelpLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content shadow border-0">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="pendingApprovalHelpLabel">
                <i class="fas fa-circle-info me-2"></i> Student Approval Instructions
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
            <div class="modal-body">

              <p>This section lists students who registered but are awaiting manual approval by the teacher or admin.
              </p>

              <h6 class="fw-semibold mt-3 text-secondary">üìù How to Approve/Reject:</h6>
              <ul class="ps-3">
                <li><strong>Approve:</strong> Confirms student registration and gives access to the platform.</li>
                <li><strong>Reject:</strong> Removes the student‚Äôs pending request from the system.</li>
              </ul>

              <h6 class="fw-semibold mt-3 text-secondary">üîò Actions Available:</h6>
              <ul class="ps-3">
                <li><strong>Individual Approval:</strong> Click <i class="fas fa-check-circle text-success"></i> or <i
                    class="fas fa-times-circle text-danger"></i> for each student.</li>
                <li><strong>Bulk Approval/Reject:</strong> Use checkboxes to select students and click on:
                  <ul>
                    <li><i class="fas fa-check-double text-success"></i> Approve Selected</li>
                    <li><i class="fas fa-times-circle text-danger"></i> Reject Selected</li>
                  </ul>
                </li>
              </ul>

              <h6 class="fw-semibold mt-3 text-secondary">üîç Using the Search Box:</h6>
              <p>Quickly filter students by typing their name, class, subject, etc.</p>

              <h6 class="fw-semibold mt-3 text-secondary">üì§ Export:</h6>
              <p>Click <i class="fas fa-download text-primary"></i> to download the current list as a CSV for records.
              </p>

              <div class="alert alert-warning mt-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> Approved students will immediately be moved to the active student list.
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Close
              </button>
            </div>
          </div>
        </div>
      </div>

      {% if pending_students %}
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-primary d-flex align-items-center">
                <i class="fas fa-user-clock me-2"></i> Pending Student Approvals
              </h5>
            </div>

            <div class="card-body">

              <div class="mb-4">
                <input type="text" id="studentSearchInput" class="form-control form-control-sm"
                  placeholder="üîç Search student by name, class, subject..." oninput="filterStudents()">
              </div>
              <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-outline-success btn-sm" onclick="bulkStudentAction('approve')">
                  <i class="fas fa-check-double me-1"></i>Approve Selected
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="bulkStudentAction('reject')">
                  <i class="fas fa-times-circle me-1"></i>Reject Selected
                </button>
              </div>

              <style>
                #pendingStudentsTable thead th {
                  position: sticky;
                  top: 0;
                  background: #f8f9fa;
                  z-index: 1;
                }
              </style>
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <div class="d-flex justify-content-end gap-2 p-2 flex-wrap">
                  <button id="downloadsCSV" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download me-1"></i> Download CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#pendingApprovalHelpModal">
                    <i class="fas fa-circle-info me-1"></i> Instructions
                  </button>
                </div>
                <script>
                  document.getElementById('downloadsCSV').addEventListener('click', function () {
                    const table = document.getElementById('pendingStudentsTable');
                    const allRows = table.querySelectorAll('thead tr, tbody tr');
                    let csv = [];

                    allRows.forEach(row => {
                      if (row.offsetParent !== null) {
                        const cols = row.querySelectorAll('th, td');
                        const rowData = [];
                        cols.forEach(col => {
                          let text = col.innerText.trim().replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                          rowData.push(`"${text}"`);
                        });
                        csv.push(rowData.join(','));
                      }
                    });

                    const csvContent = csv.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'pending_students.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                  });
                </script>

                <table class="table table-hover align-middle mb-0" id="pendingStudentsTable">
                  <thead class="table-light">
                    <tr>
                      <th><input type="checkbox" id="selectAllStudents" onchange="toggleAllStudentCheckboxes(this)">
                      </th>
                      <th><i class="fas fa-user me-1"></i> Name</th>
                      <th><i class="fas fa-id-badge me-1"></i> Roll Number</th>
                      <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>
                      {% if institution_type == 'school' %}
                      {% set has_11_12 = [] %}
                      {% for student in pending_students %}
                      {% if student.class_name.startswith('11') or student.class_name.startswith('12') %}
                      {% set _ = has_11_12.append(1) %}
                      {% endif %}
                      {% endfor %}

                      {% if has_11_12 %}
                      <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                      {% endif %}
                      {% endif %}
                      {% if institution_type != 'school' %}
                      <th><i class="fas fa-book-open me-1"></i> Subject</th>
                      <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                      {% endif %}
                      <th><i class="fas fa-calendar-day me-1"></i> Registered On</th>
                      <th><i class="fas fa-cogs me-1"></i> Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for student in pending_students %}
                    <tr>
                      <td><input type="checkbox" class="student-checkbox" value="{{ student.id }}"></td>
                      <td>{{ student.username }}</td>
                      <td>{{ student.roll_number }}</td>
                      <td><span class="badge bg-secondary">{{ student.class_name }}</span></td>

                      {% if institution_type == 'school' and has_11_12 %}
                      {% if student.class_name.startswith('11') or student.class_name.startswith('12') %}
                      <td>{{ student.stream_or_semester or '-' }}</td>
                      {% else %}
                      <td>-</td>
                      {% endif %}
                      {% endif %}

                      {% if institution_type != 'school' %}
                      <td>{{ student.subject or '-' }}</td>
                      <td>{{ student.degree or '-' }}</td>
                      {% endif %}

                      <td>{{ student.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                      <td>
                        <div class="d-flex gap-2 flex-nowrap">
                          <button class="btn btn-sm btn-success"
                            onclick="handleStudentAction({{ student.id }}, 'approve', this)">
                            <i class="fas fa-check-circle me-1"></i>Approve
                          </button>
                          <button class="btn btn-sm btn-danger"
                            onclick="handleStudentAction({{ student.id }}, 'reject', this)">
                            <i class="fas fa-times-circle me-1"></i>Reject
                          </button>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>
      <script>
        function handleStudentAction(studentId, action, btnElement) {
          btnElement.disabled = true;
          const originalHTML = btnElement.innerHTML;
          btnElement.innerHTML = `${action.charAt(0).toUpperCase() + action.slice(1)}ing...`;

          fetch(`/teacher/${action}-student/${studentId}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(() => {
              btnElement.parentElement.innerHTML = `<span class="badge bg-${action === 'approve' ? 'success' : 'danger'}">Student ${action}d</span>`;
            })
            .catch(() => {
              btnElement.disabled = false;
              btnElement.innerHTML = originalHTML;
            });
        }

        function toggleAllStudentCheckboxes(master) {
          document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = master.checked);
        }

        function bulkStudentAction(action) {
          const selected = [...document.querySelectorAll('.student-checkbox:checked')].map(cb => cb.value);
          if (selected.length === 0) return alert('Select at least one student.');
          if (!confirm(`Are you sure to ${action} ${selected.length} students?`)) return;

          const btn = document.querySelector(`button[onclick="bulkStudentAction('${action}')"]`);
          const originalHTML = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = `${action.charAt(0).toUpperCase() + action.slice(1)}ing...`;

          fetch(`/teacher/bulk-${action}-students`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ student_ids: selected })
          })
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(() => {
              selected.forEach(id => {
                const row = document.querySelector(`.student-checkbox[value="${id}"]`).closest('tr');
                row.innerHTML = `<td colspan="8"><span class="badge bg-${action === 'approve' ? 'success' : 'danger'}">Student ${action}d</span></td>`;
              });
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            })
            .catch(() => {
              alert('Bulk action failed. Try again.');
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            });
        }
      </script>

      <script>
        function filterStudents() {
          const input = document.getElementById("studentSearchInput").value.toLowerCase().trim();
          const rows = document.querySelectorAll("#pendingStudentsTable tbody tr");

          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
          });
        }
      </script>

      {% endif %}

      <div class="modal fade" id="atRiskHelpModal" tabindex="-1" aria-labelledby="atRiskHelpLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content shadow border-0">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="atRiskHelpLabel">
                <i class="fas fa-circle-info me-2"></i> At-Risk Student Guidance
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
            <div class="modal-body">

              <p>This section highlights students whose attendance has fallen below acceptable levels.</p>

              <h6 class="fw-semibold mt-3 text-secondary">‚ö†Ô∏è What ‚ÄúAt Risk‚Äù Means:</h6>
              <ul class="ps-3">
                <li>Students with attendance below <strong>60%</strong> are flagged as <span
                    class="badge bg-warning text-dark">At Risk</span>.</li>
                <li>They may require intervention, follow-up, or counseling.</li>
              </ul>

              <h6 class="fw-semibold mt-3 text-secondary">üîç Features:</h6>
              <ul class="ps-3">
                <li><strong>Search:</strong> Filter by name, class, or subject for quick access.</li>
                <li><strong>Stream or Degree:</strong> Displayed based on institution type.</li>
                <li><strong>Export:</strong> Download this list as a CSV for parent meetings or administrative review.
                </li>
              </ul>

              <div class="alert alert-warning mt-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Reminder:</strong> Regular follow-up with at-risk students can significantly improve retention
                and performance.
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Close
              </button>
            </div>
          </div>
        </div>
      </div>

      {% if insights.at_risk_in_classes %}
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div class="card-header bg-light d-flex align-items-center">
              <h5 class="mb-0 text-danger d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                Students at Risk in Your Classes
              </h5>
            </div>

            <div class="card-body">

              <div class="mb-4">
                <input type="text" id="riskSearchInput" class="form-control form-control-sm"
                  placeholder="üîç Search student by name, class, or subject..." oninput="filterRiskStudents()">
              </div>

              <style>
                #riskStudentsTable thead th {
                  position: sticky;
                  top: 0;
                  background: #f8f9fa;
                  z-index: 1;
                }
              </style>
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <div class="d-flex justify-content-end gap-2 p-2 flex-wrap">
                  <button id="downloadCSV" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download me-1"></i> Download CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#atRiskHelpModal">
                    <i class="fas fa-circle-info me-1"></i> Instructions
                  </button>
                </div>
                <script>
                  document.getElementById('downloadCSV').addEventListener('click', function () {
                    const table = document.getElementById('riskStudentsTable');
                    const allRows = table.querySelectorAll('thead tr, tbody tr');
                    let csv = [];

                    allRows.forEach(row => {
                      if (row.offsetParent !== null) {
                        const cols = row.querySelectorAll('th, td');
                        const rowData = [];
                        cols.forEach(col => {
                          let text = col.innerText.trim().replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                          rowData.push(`"${text}"`);
                        });
                        csv.push(rowData.join(','));
                      }
                    });

                    const csvContent = csv.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'risk_students.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                  });
                </script>

                <table class="table table-hover align-middle mb-0" id="riskStudentsTable">
                  <thead class="table-light">
                    <tr>
                      <th><i class="fas fa-user me-1"></i> Name</th>
                      <th><i class="fas fa-id-badge me-1"></i> Roll Number</th>
                      <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>

                      {% if institution_type == 'school' %}
                      {% set show_stream = [] %}
                      {% for item in insights.at_risk_in_classes %}
                      {% if item.class.startswith('11') or item.class.startswith('12') %}
                      {% set _ = show_stream.append(1) %}
                      {% endif %}
                      {% endfor %}

                      {% if show_stream %}
                      <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                      {% endif %}
                      {% else %}
                      <th><i class="fas fa-book-open me-1"></i> Subject</th>
                      <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                      {% endif %}

                      <th><i class="fas fa-percentage me-1"></i> Attendance %</th>
                      <th><i class="fas fa-triangle-exclamation me-1"></i> Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for student_info in insights.at_risk_in_classes %}
                    <tr>
                      <td>{{ student_info.student.username }}</td>
                      <td>{{ student_info.student.roll_number }}</td>
                      <td><span class="badge bg-primary">{{ student_info.class }}</span></td>

                      {% if institution_type == 'school' %}
                      {% if show_stream %}
                      {% if student_info.class.startswith('11') or student_info.class.startswith('12') %}
                      <td>{{ student_info.student.stream_or_semester or '-' }}</td>
                      {% else %}
                      <td>-</td>
                      {% endif %}
                      {% endif %}
                      {% else %}
                      <td>
                        {{ student_info.subject if student_info.subject else '‚ö† Missing Subject' }}
                      </td>
                      <td>{{ student_info.student.degree or '-' }}</td>
                      {% endif %}

                      <td>
                        <span class="badge bg-{{ 'danger' if student_info.percentage < 60 else 'warning' }}">
                          {{ student_info.percentage }}%
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-warning text-dark">
                          <i class="fas fa-exclamation-circle me-1"></i> At Risk
                        </span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterRiskStudents() {
          const input = document.getElementById('riskSearchInput').value.toLowerCase().trim();
          const rows = document.querySelectorAll('#riskStudentsTable tbody tr');

          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(input) ? '' : 'none';
          });
        }
      </script>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}