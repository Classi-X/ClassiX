{% extends "base.html" %}

{% block title %}Teacher Dashboard | ClassiX | AI Attendance Management for Schools & Colleges{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div
      class="d-md-none bg-gradient bg-primary text-white d-flex justify-content-between align-items-center px-4 py-3 shadow-sm rounded-bottom animate__animated animate__fadeInDown">
      <div class="d-flex align-items-center">
        <i class="fas fa-chart-line fs-4 me-2"></i>
        <h5 class="mb-0 fw-semibold">Dashboard</h5>
      </div>
      <button
        class="btn btn-light btn-sm rounded-circle shadow-sm d-flex align-items-center justify-content-center transition"
        onclick="toggleSidebar()" aria-label="Toggle Sidebar">
        <i class="fas fa-bars text-primary fs-5"></i>
      </button>
    </div>

    <style>
      .transition {
        transition: all 0.3s ease-in-out;
      }

      .btn-light:hover {
        background-color: #e2e6ea;
        transform: scale(1.05);
      }
    </style>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('d-none');
        sidebar.classList.toggle('d-block');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const blinkArea = document.getElementById('blinkArea');

        async function checkNewChats() {
          try {
            const res = await fetch('/chat/has-new');
            const data = await res.json();
            blinkArea.classList.toggle('blinking', data.new_message);
          } catch (err) {
            console.error("Error checking chat notifications", err);
          }
        }

        checkNewChats();
        setInterval(checkNewChats, 10000);
      });
    </script>


    <div id="sidebar"
      class="col-md-3 col-lg-2 bg-white border-end shadow-sm p-0 sidebar-collapse d-none d-md-block animate__animated animate__fadeInLeft">
      <nav class="list-group list-group-flush rounded-0 py-3">

        <a href="{{ url_for('teacher_dashboard') }}"
          class="d-none d-md-inline list-group-item list-group-item-action active d-flex align-items-center">
          <i class="fas fa-tachometer-alt me-2"></i> Dashboard
        </a>


        <a href="{{ url_for('assign_classes') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-chalkboard-teacher me-2"></i> Assign Classes
        </a>

        <a href="{{ url_for('mark_attendance') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-check-circle me-2"></i> Mark Attendance
        </a>

        <a href="{{ url_for('generate_qr') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-qrcode me-2"></i> Generate QR
        </a>
        {% if current_user.institution.type.lower() == 'school' %}
        <a href="{{ url_for('add_students') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-plus me-2"></i> Add Students
        </a>
        {% endif %}

        <a href="{{ url_for('parent_status') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-friends me-2"></i> Parent Status
        </a>


        <a href="{{ url_for('attendance_records') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-clipboard-list me-2"></i> Attendance Records
        </a>

        <a href="{{ url_for('students_in_class') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-users me-2"></i> Students in Class
        </a>

        <a href="{{ url_for('teacher_list') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-chalkboard-teacher me-2"></i> Teacher Directory
        </a>

        <a href="{{ url_for('student_list') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-graduate me-2"></i> Student Directory
        </a>

        <a href="{{ url_for('view_own_profile') }}"
          class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user me-2"></i> Profile
        </a>

        <a href="{{ url_for('logout') }}" class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>


        <a href="{{ url_for('chat_history') }}"
          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center position-relative"
          id="myChatsLink">
          <div class="d-flex align-items-center blink-area" id="blinkArea">
            <i class="fas fa-comments me-2"></i>
            <span>My Chats</span>
          </div>
        </a>


        <a href="{{ url_for('about') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-info-circle me-2"></i> About Us
        </a>

        <a href="{{ url_for('contact') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-envelope me-2"></i> Contact
        </a>

        <a href="/chat/32" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-user-shield me-2"></i> Chat SuperAdmin
        </a>


        <a href="{{ url_for('terms') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-file-contract me-2"></i> Terms & Conditions
        </a>

        <a href="{{ url_for('privacy') }}" class="list-group-item list-group-item-action d-flex align-items-center">
          <i class="fas fa-shield-alt me-2"></i> Privacy Policy
        </a>
        <a href="{{ url_for('faq') }}" class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-question-circle me-2"></i>FAQ
        </a>
        <a href="{{ url_for('ai_chat') }}" class="sidebar-link list-group-item list-group-item-action">
          <i class="fas fa-robot me-2"></i>AI ChatBot
        </a>

      </nav>


      <style>
        .blink-area.blinking {
          color: #dc3545 !important;
          animation: blinkRed 1.2s ease-in-out infinite;
          font-weight: 600;
        }

        .blink-area.blinking i {
          color: #dc3545 !important;
        }

        @keyframes blinkRed {

          0%,
          100% {
            opacity: 1;
            text-shadow: 0 0 5px rgba(220, 53, 69, 0.6);
          }

          50% {
            opacity: 0.4;
            text-shadow: 0 0 10px rgba(220, 53, 69, 0.9);
          }
        }
      </style>


      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const blinkArea = document.getElementById('blinkArea');
          async function checkNewChats() {
            try {
              const res = await fetch('/chat/has-new');
              const data = await res.json();
              blinkArea.classList.toggle('blinking', data.new_message);
            } catch (err) {
              console.error("Error checking chat notifications", err);
            }
          }
          checkNewChats();
          setInterval(checkNewChats, 10000);
        });
      </script>

    </div>


    <div class="col-md-9 col-lg-10">

      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4 border-bottom border-primary-subtle animate__animated animate__fadeInDown">
        <h1 style="padding-bottom: 10px;" class="h3 fw-bold text-primary d-flex align-items-center mb-0">
          <i class="fas fa-chalkboard-teacher me-2"></i> Teacher Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-primary shadow-sm">
              <i class="fas fa-calendar-alt me-2"></i>{{ current_month_year }}
            </button>
          </div>
        </div>
      </div>


      <div class="row g-4">

        <div class="col-sm-6 col-md-3">
          <div
            class="card shadow-sm border-0 text-white bg-gradient bg-primary h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">Classes Assigned</h6>
                <h3 class="mb-0">{{ assignments|length }}</h3>
              </div>
              <i class="fas fa-chalkboard-teacher fa-2x opacity-75"></i>
            </div>
          </div>
        </div>


        <div class="col-sm-6 col-md-3">
          <div class="card shadow-sm border-0 text-white bg-gradient bg-info h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">Pending Approvals</h6>
                <h3 class="mb-0">{{ pending_students|length }}</h3>
              </div>
              <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
          </div>
        </div>


        <div class="col-sm-6 col-md-3">
          <div
            class="card shadow-sm border-0 text-white bg-gradient bg-success h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">Subjects Taught</h6>
                <h3 class="mb-0">{{ insights.teacher_stats.classes_taught }}</h3>
              </div>
              <i class="fas fa-book fa-2x opacity-75"></i>
            </div>
          </div>
        </div>


        <div class="col-sm-6 col-md-3">
          <div
            class="card shadow-sm border-0 text-white bg-gradient bg-warning h-100 animate__animated animate__fadeInUp">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase fw-semibold mb-1">At Risk Students</h6>
                <h3 class="mb-0">{{ insights.at_risk_in_classes|length }}</h3>
              </div>
              <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>






      <style>
        .card {
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          border-radius: 0.75rem;
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
        }

        h6 {
          letter-spacing: 0.5px;
        }
      </style>


      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div
              class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
              <h5 class="mb-0 text-secondary d-flex align-items-center">
                <i class="fas fa-chalkboard-teacher me-2 text-primary"></i> My Assigned Classes
              </h5>
              <a href="{{ url_for('assign_classes') }}" class="btn btn-sm btn-primary shadow-sm">
                <i class="fas fa-plus me-1"></i> Assign New Class/Semester
              </a>
            </div>

            <div class="card-body">
              {% if assignments %}

              <div class="mb-4">
                <input type="text" id="assignmentSearchInput" class="form-control form-control-sm"
                  placeholder="ðŸ” Search by class, subject, stream, or degree..." oninput="filterAssignments()">
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle" id="assignmentTable">
                  <thead class="table-light">
                    <tr>
                      <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>
                      {% set has_11_12 = assignments | selectattr('class_name', 'in', ['11', '12']) | list %}
                      {% if institution_type == 'school' and has_11_12 %}
                      <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                      {% endif %}
                      {% if institution_type != 'school' %}
                      <th><i class="fas fa-book-open me-1"></i> Subject</th>
                      <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                      {% endif %}
                      <th><i class="fas fa-calendar-day me-1"></i> Assigned Date</th>
                      <th><i class="fas fa-cogs me-1"></i> Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for assignment in assignments %}
                    <tr>
                      <td><span class="badge bg-primary">{{ assignment.class_name }}</span></td>

                      {% if institution_type == 'school' and has_11_12 %}
                      {% if assignment.class_name in ['11', '12'] %}
                      <td>{{ assignment.stream_or_semester or '-' }}</td>
                      {% else %}
                      <td>-</td>
                      {% endif %}
                      {% endif %}

                      {% if institution_type != 'school' %}
                      <td>{{ assignment.subject }}</td>
                      <td>{{ assignment.degree or '-' }}</td>
                      {% endif %}

                      <td>{{ assignment.created_at.strftime('%Y-%m-%d') }}</td>
                      <td>
                        {% set pair = (assignment.class_name, assignment.subject) %}
                        {% if pair in marked_today_pairs %}
                        <span class="badge bg-success text-white">
                          <i class="fas fa-check-circle me-1"></i> Attendance marked
                        </span>
                        {% else %}
                        <a href="{{ url_for('mark_attendance') }}?class={{ assignment.class_name }}&subject={{ assignment.subject }}"
                          class="btn btn-sm btn-outline-success">
                          <i class="fas fa-check-circle me-1"></i> Mark Attendance
                        </a>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              {% else %}

              <div class="text-center py-5">
                <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3 animate__animated animate__fadeInDown"></i>
                <p class="text-muted">No classes assigned yet.</p>
                <a href="{{ url_for('assign_classes') }}" class="btn btn-primary shadow-sm">
                  <i class="fas fa-plus me-2"></i> Assign Your First Class
                </a>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterAssignments() {
          const input = document.getElementById('assignmentSearchInput').value.toLowerCase().trim();
          const rows = document.querySelectorAll('#assignmentTable tbody tr');
          rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
          });
        }
      </script>






      {% if insights.subject_performance %}
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div class="card-header bg-light d-flex align-items-center">
              <h5 class="mb-0 text-primary d-flex align-items-center">
                <i class="fas fa-chart-bar me-2"></i> Subject Performance
              </h5>
            </div>

            <div class="card-body">

              <div class="mb-4">
                <input type="text" id="subjectSearchInput" class="form-control form-control-sm"
                  placeholder="ðŸ” Search subjects..." oninput="filterSubjectPerformance()">
              </div>

              <div class="row g-3" id="subjectPerformanceContainer">
                {% for subject, stats in insights.subject_performance.items() %}
                <div class="col-sm-6 col-md-4 subject-card">
                  <div class="card h-100 shadow-sm border-0 bg-light animate__animated animate__fadeIn">
                    <div class="card-body">
                      <h6 class="card-title fw-semibold text-secondary mb-3 d-flex align-items-center">
                        <i class="fas fa-book-open me-2 text-info"></i> {{ subject }}
                      </h6>

                      <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-{{
                      'success' if stats.average_attendance >= 75 else
                      'warning' if stats.average_attendance >= 60 else
                      'danger'
                    }}" style="width: {{ stats.average_attendance }}%">
                          {{ stats.average_attendance }}%
                        </div>
                      </div>

                      <small class="text-muted d-block">
                        <i class="fas fa-users me-1"></i> {{ stats.student_count }} students
                      </small>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterSubjectPerformance() {
          const input = document.getElementById("subjectSearchInput").value.toLowerCase().trim();
          const cards = document.querySelectorAll("#subjectPerformanceContainer .subject-card");

          cards.forEach(card => {
            const title = card.querySelector(".card-title").textContent.toLowerCase();
            if (title.includes(input)) {
              card.classList.remove("d-none");
            } else {
              card.classList.add("d-none");
            }
          });
        }
      </script>




      {% endif %}


      {% if pending_students %}
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-primary d-flex align-items-center">
                <i class="fas fa-user-clock me-2"></i> Pending Student Approvals
              </h5>
            </div>

            <div class="card-body">

              <div class="mb-4">
                <input type="text" id="studentSearchInput" class="form-control form-control-sm"
                  placeholder="ðŸ” Search student by name, class, subject..." oninput="filterStudents()">
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="pendingStudentsTable">
                  <thead class="table-light">
                    <tr>
                      <th><i class="fas fa-user me-1"></i> Name</th>
                      <th><i class="fas fa-id-badge me-1"></i> Roll Number</th>
                      <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>
                      {% if institution_type == 'school' %}
                      {% set has_11_12 = pending_students | selectattr('class_name', 'in', ['11', '12']) | list %}
                      {% if has_11_12 %}
                      <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                      {% endif %}
                      {% endif %}
                      {% if institution_type != 'school' %}
                      <th><i class="fas fa-book-open me-1"></i> Subject</th>
                      <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                      {% endif %}
                      <th><i class="fas fa-calendar-day me-1"></i> Registered On</th>
                      <th><i class="fas fa-cogs me-1"></i> Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for student in pending_students %}
                    <tr>
                      <td>{{ student.username }}</td>
                      <td>{{ student.roll_number }}</td>
                      <td><span class="badge bg-secondary">{{ student.class_name }}</span></td>

                      {% if institution_type == 'school' and has_11_12 %}
                      {% if student.class_name in ['11', '12'] %}
                      <td>{{ student.stream_or_semester or '-' }}</td>
                      {% else %}
                      <td>-</td>
                      {% endif %}
                      {% endif %}

                      {% if institution_type != 'school' %}
                      <td>{{ student.subject or '-' }}</td>
                      <td>{{ student.degree or '-' }}</td>
                      {% endif %}

                      <td>{{ student.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                      <td>
                        <a href="{{ url_for('approve_student', student_id=student.id) }}" class="btn btn-sm btn-success"
                          onclick="return confirm('Approve this student?')">
                          <i class="fas fa-check-circle me-1"></i> Approve
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterStudents() {
          const input = document.getElementById("studentSearchInput").value.toLowerCase().trim();
          const rows = document.querySelectorAll("#pendingStudentsTable tbody tr");

          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
          });
        }
      </script>




      {% endif %}


      {% if insights.at_risk_in_classes %}
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm border-0 animate__animated animate__fadeInUp">
            <div class="card-header bg-light d-flex align-items-center">
              <h5 class="mb-0 text-danger d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                Students at Risk in Your Classes
              </h5>
            </div>

            <div class="card-body">

              <div class="mb-4">
                <input type="text" id="riskSearchInput" class="form-control form-control-sm"
                  placeholder="ðŸ” Search student by name, class, or subject..." oninput="filterRiskStudents()">
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="riskStudentsTable">
                  <thead class="table-light">
                    <tr>
                      <th><i class="fas fa-user me-1"></i> Name</th>
                      <th><i class="fas fa-id-badge me-1"></i> Roll Number</th>
                      <th><i class="fas fa-layer-group me-1"></i> Class/Semester</th>

                      {% if institution_type == 'school' %}
                      {% set show_stream = insights.at_risk_in_classes | selectattr('class', 'in', ['11', '12']) | list
                      %}
                      {% if show_stream %}
                      <th><i class="fas fa-code-branch me-1"></i> Stream</th>
                      {% endif %}
                      {% else %}
                      <th><i class="fas fa-book-open me-1"></i> Subject</th>
                      <th><i class="fas fa-graduation-cap me-1"></i> Degree</th>
                      {% endif %}

                      <th><i class="fas fa-percentage me-1"></i> Attendance %</th>
                      <th><i class="fas fa-triangle-exclamation me-1"></i> Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for student_info in insights.at_risk_in_classes %}
                    <tr>
                      <td>{{ student_info.student.username }}</td>
                      <td>{{ student_info.student.roll_number }}</td>
                      <td><span class="badge bg-primary">{{ student_info.class }}</span></td>

                      {% if institution_type == 'school' %}
                      {% if show_stream %}
                      {% if student_info.class in ['11', '12'] %}
                      <td>{{ student_info.student.stream_or_semester or '-' }}</td>
                      {% else %}
                      <td>-</td>
                      {% endif %}
                      {% endif %}
                      {% else %}
                      <td>
                        {{ student_info.subject if student_info.subject else 'âš  Missing Subject' }}
                      </td>
                      <td>{{ student_info.student.degree or '-' }}</td>
                      {% endif %}

                      <td>
                        <span class="badge bg-{{ 'danger' if student_info.percentage < 60 else 'warning' }}">
                          {{ student_info.percentage }}%
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-warning text-dark">
                          <i class="fas fa-exclamation-circle me-1"></i> At Risk
                        </span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>


      <script>
        function filterRiskStudents() {
          const input = document.getElementById('riskSearchInput').value.toLowerCase().trim();
          const rows = document.querySelectorAll('#riskStudentsTable tbody tr');

          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(input) ? '' : 'none';
          });
        }
      </script>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}